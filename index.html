<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tianhe 3D Housing Analytics V6.1</title>
    
    <script src="https://cdn.staticfile.org/tailwindcss/3.3.3/tailwind.min.js"></script>
    <script crossorigin src="https://cdn.staticfile.org/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdn.staticfile.org/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.staticfile.org/babel-standalone/7.22.17/babel.min.js"></script>
    <script src="https://unpkg.com/deck.gl@8.9.33/dist.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- 全局样式 --- */
        * { font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        body { margin: 0; background: #ffffff; overflow: hidden; font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; color: #202124; -webkit-font-smoothing: antialiased; letter-spacing: 0.01em; }
        #map-container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 0; }
        
        /* 玻璃拟态 (V6 专业版) */
        .glass-panel {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 12px;
            box-shadow: 0 4px 24px -1px rgba(0, 0, 0, 0.25);
        }

        /* 封面页 - Google Antigravity 风格 */
        #landing-page {
            position: fixed; inset: 0; z-index: 9999;
            background: #ffffff;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; transition: opacity 0.6s ease;
        }
        
        /* 粒子画布 */
        #particle-canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 0;
        }
        
        .landing-content {
            position: relative;
            z-index: 1;
            max-width: 900px;
            padding: 0 20px;
        }
        
        .title-main {
            font-size: 4.5rem;
            font-weight: 400;
            color: #202124;
            margin: 0 0 0.5rem 0;
            letter-spacing: -0.02em;
            line-height: 1.1;
        }
        
        .title-sub {
            font-size: 2.8rem;
            font-weight: 300;
            color: #5f6368;
            margin: 0 0 3rem 0;
            letter-spacing: -0.01em;
        }
        
        .tag { 
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px; 
            background: transparent;
            color: #5f6368;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 2rem;
            letter-spacing: 0;
        }
        
        .tag-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #4285f4 25%, #ea4335 50%, #fbbc04 75%, #34a853 100%);
            -webkit-background-clip: text;
            border-radius: 4px;
        }
        
        /* 按钮组 */
        .btn-group {
            display: flex;
            gap: 12px;
            justify-content: center;
            align-items: center;
        }
        
        .btn-primary {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 14px 28px;
            font-size: 0.95rem;
            font-weight: 500;
            background: #1a1a1a;
            color: #ffffff;
            border: none;
            border-radius: 100px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .btn-primary:hover { 
            background: #000000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .btn-primary:disabled { 
            background: #e8eaed; 
            color: #9aa0a6; 
            box-shadow: none; 
            cursor: default; 
        }
        
        .btn-secondary {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 14px 28px;
            font-size: 0.95rem;
            font-weight: 500;
            background: #ffffff;
            color: #1a1a1a;
            border: 1px solid #dadce0;
            border-radius: 100px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-secondary:hover {
            background: #f8f9fa;
            border-color: #1a1a1a;
        }

        /* 双向范围滑块样式 */
        .range-slider {
            position: relative;
            width: 100%;
            height: 24px;
            display: flex;
            align-items: center;
        }
        .range-slider-track {
            position: absolute;
            width: 100%;
            height: 3px;
            background: #334155;
            border-radius: 2px;
            pointer-events: none;
        }
        .range-slider-range {
            position: absolute;
            height: 3px;
            background: #667eea;
            border-radius: 2px;
            pointer-events: none;
        }
        .range-slider input[type=range] {
            position: absolute;
            width: 100%;
            height: 0;
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            pointer-events: none;
            margin: 0;
            padding: 0;
        }
        .range-slider input[type=range]::-webkit-slider-runnable-track {
            height: 0;
            background: transparent;
            border: none;
        }
        .range-slider input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            pointer-events: auto;
            box-shadow: 0 1px 4px rgba(0,0,0,0.3);
            margin-top: -8px;
        }
        .range-slider input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }
        .range-slider input[type=range]::-moz-range-track {
            height: 0;
            background: transparent;
            border: none;
        }
        .range-slider input[type=range]::-moz-range-thumb {
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            pointer-events: auto;
            box-shadow: 0 1px 4px rgba(0,0,0,0.3);
            border: none;
        }

        /* 滑块 (V6 样式) - 保留作为后备 */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; margin: 8px 0; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%;
            background: white; cursor: pointer; margin-top: -5px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.1); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #334155; border-radius: 2px; }

        /* POI 按钮 (V6 样式) - 更紧凑 */
        .poi-btn {
            display: flex; align-items: center; justify-content: center; gap: 5px;
            padding: 6px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 500;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08);
            color: #94a3b8; cursor: pointer; transition: all 0.2s;
        }
        .poi-btn:hover { background: rgba(255,255,255,0.08); color: #cbd5e1; }
        .poi-btn.active { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); color: white; }
        
        /* 指示形状 - 不同POI使用不同形状和非绿色颜色 */
        .shape { width: 10px; height: 10px; display: inline-block; }
        
        /* Metro: 圆角方形 - 蓝色 */
        .shape.subway { 
            background: #38bdf8; 
            border-radius: 2px;
            box-shadow: 0 0 8px rgba(56, 189, 248, 0.5); 
        }
        
        /* Mall: 菱形 - 粉色 */
        .shape.mall { 
            background: #f472b6; 
            transform: rotate(45deg);
            box-shadow: 0 0 8px rgba(244, 114, 182, 0.5); 
        }
        
        /* School: 三角形 - 橙色 */
        .shape.school { 
            width: 0; height: 0;
            background: transparent;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 10px solid #fb923c;
            filter: drop-shadow(0 0 4px rgba(251, 146, 60, 0.5));
        }
        
        /* Park: 六边形 - 紫色 */
        .shape.park { 
            background: #c084fc;
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            box-shadow: 0 0 8px rgba(192, 132, 252, 0.5); 
        }
        
        /* Public: 五角星 - 红色 */
        .shape.public_service { 
            background: #f87171;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            box-shadow: 0 0 8px rgba(248, 113, 113, 0.5); 
        }

        .fade-in-up { animation: fadeInUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }

        /* 辅助文本 */
        .label-sm { font-size: 0.75rem; font-weight: 600; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; }
        .value-mono { font-family: 'Roboto Mono', monospace; font-weight: 500; }
        
        .status-text {
            margin-top: 2.5rem;
            font-size: 0.85rem;
            color: #9aa0a6;
            font-weight: 400;
        }
        
        /* AI Chatbot 样式 */
        .ai-chat-toggle {
            position: fixed;
            bottom: 24px;
            left: 24px;
            width: 56px;
            height: 56px;
            border-radius: 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        .ai-chat-toggle:hover {
            transform: scale(1.08);
            box-shadow: 0 6px 28px rgba(102, 126, 234, 0.5);
        }
        .ai-chat-toggle.expanded {
            transform: rotate(45deg);
        }
        
        .ai-chat-panel {
            position: fixed;
            bottom: 96px;
            left: 24px;
            width: 380px;
            max-height: 520px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 16px;
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.4);
            z-index: 999;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transform: translateY(20px);
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .ai-chat-panel.open {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
        
        .ai-chat-header {
            padding: 16px 20px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .ai-avatar {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .ai-chat-title {
            flex: 1;
        }
        .ai-chat-title h3 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            color: #e2e8f0;
        }
        .ai-chat-title p {
            margin: 2px 0 0 0;
            font-size: 11px;
            color: #64748b;
        }
        
        .ai-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 320px;
            min-height: 200px;
        }
        .ai-chat-messages::-webkit-scrollbar {
            width: 4px;
        }
        .ai-chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }
        .ai-chat-messages::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
        }
        
        .chat-message {
            display: flex;
            gap: 10px;
            animation: messageSlide 0.3s ease forwards;
        }
        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-message.user {
            flex-direction: row-reverse;
        }
        .chat-message-avatar {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 12px;
        }
        .chat-message.ai .chat-message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .chat-message.user .chat-message-avatar {
            background: #3b82f6;
        }
        .chat-message-content {
            max-width: 75%;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 13px;
            line-height: 1.5;
        }
        .chat-message.ai .chat-message-content {
            background: rgba(255, 255, 255, 0.08);
            color: #e2e8f0;
            border-bottom-left-radius: 4px;
        }
        .chat-message.user .chat-message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .chat-message-action {
            margin-top: 8px;
            padding: 8px 10px;
            background: rgba(102, 126, 234, 0.15);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 8px;
            font-size: 11px;
            color: #a78bfa;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .chat-message-action::before {
            content: '⚡';
        }
        
        .ai-chat-input-area {
            padding: 12px 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .ai-chat-input {
            flex: 1;
            padding: 10px 14px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #e2e8f0;
            font-size: 13px;
            outline: none;
            transition: all 0.2s;
        }
        .ai-chat-input:focus {
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.08);
        }
        .ai-chat-input::placeholder {
            color: #64748b;
        }
        .ai-chat-send {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .ai-chat-send:hover {
            transform: scale(1.05);
        }
        .ai-chat-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 10px 14px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            width: fit-content;
        }
        .typing-dot {
            width: 6px;
            height: 6px;
            background: #64748b;
            border-radius: 50%;
            animation: typingBounce 1.4s infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }
        
        .quick-prompts {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 0 16px 12px 16px;
        }
        .quick-prompt {
            padding: 6px 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            font-size: 11px;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.2s;
        }
        .quick-prompt:hover {
            background: rgba(102, 126, 234, 0.15);
            border-color: rgba(102, 126, 234, 0.4);
            color: #a78bfa;
        }

        /* Methodology Page - Full Screen Navigation Style */
        .methodology-page {
            position: fixed;
            inset: 0;
            z-index: 10000;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }
        .methodology-page.open {
            opacity: 1;
            pointer-events: auto;
        }
        
        .methodology-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            background: #ffffff;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            align-items: center;
            padding: 0 40px;
            z-index: 10001;
        }
        
        .methodology-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.1rem;
            font-weight: 500;
            color: #202124;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .methodology-logo:hover {
            opacity: 0.7;
        }
        .methodology-logo svg {
            width: 28px;
            height: 28px;
        }
        
        .methodology-tabs {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 60px;
            flex: 1;
        }
        
        .methodology-tab {
            padding: 8px 16px;
            font-size: 0.875rem;
            font-weight: 500;
            color: #5f6368;
            background: transparent;
            border: none;
            border-radius: 100px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .methodology-tab:hover {
            background: #f1f3f4;
            color: #202124;
        }
        .methodology-tab.active {
            background: #e8f0fe;
            color: #1a73e8;
        }
        
        .methodology-close-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            font-size: 0.875rem;
            font-weight: 500;
            color: #ffffff;
            background: #1a1a1a;
            border: none;
            border-radius: 100px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .methodology-close-btn:hover {
            background: #000000;
        }
        
        .methodology-body {
            flex: 1;
            margin-top: 64px;
            overflow-y: auto;
            position: relative;
        }
        
        .methodology-canvas {
            position: fixed;
            top: 64px;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 0;
        }
        
        .methodology-section {
            position: relative;
            z-index: 1;
            min-height: calc(100vh - 64px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 80px 40px;
            text-align: center;
        }
        
        .methodology-section-content {
            max-width: 800px;
            text-align: left;
        }
        
        .methodology-section h1 {
            font-size: 3.5rem;
            font-weight: 400;
            color: #202124;
            margin: 0 0 1.5rem 0;
            letter-spacing: -0.02em;
            text-align: center;
        }
        
        .methodology-section h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #202124;
            margin: 2rem 0 1rem 0;
        }
        
        .methodology-section p {
            font-size: 1.125rem;
            line-height: 1.8;
            color: #5f6368;
            margin-bottom: 1.25rem;
        }
        
        .methodology-section ul {
            list-style: none;
            padding: 0;
            margin: 1.5rem 0;
        }
        
        .methodology-section li {
            position: relative;
            padding-left: 28px;
            margin-bottom: 1rem;
            font-size: 1.0625rem;
            line-height: 1.7;
            color: #5f6368;
        }
        
        .methodology-section li::before {
            content: '';
            position: absolute;
            left: 0;
            top: 10px;
            width: 8px;
            height: 8px;
            background: #4285f4;
            border-radius: 50%;
        }
        
        .methodology-section li:nth-child(2)::before { background: #ea4335; }
        .methodology-section li:nth-child(3)::before { background: #fbbc04; }
        .methodology-section li:nth-child(4)::before { background: #34a853; }
        .methodology-section li:nth-child(5)::before { background: #4285f4; }
        
        .methodology-section strong {
            color: #202124;
            font-weight: 600;
        }
        
        .methodology-highlight {
            display: inline-block;
            padding: 4px 12px;
            background: linear-gradient(135deg, #e8f0fe 0%, #fce8e6 100%);
            border-radius: 4px;
            font-weight: 500;
            color: #1a73e8;
        }
        
        .methodology-stat {
            display: flex;
            gap: 40px;
            justify-content: center;
            margin: 2rem 0;
            flex-wrap: wrap;
        }
        
        .methodology-stat-item {
            text-align: center;
        }
        
        .methodology-stat-value {
            font-size: 2.5rem;
            font-weight: 300;
            color: #1a73e8;
            font-family: 'Roboto Mono', monospace;
        }
        
        .methodology-stat-label {
            font-size: 0.875rem;
            color: #5f6368;
            margin-top: 4px;
        }
        
        .section-divider {
            width: 60px;
            height: 4px;
            background: linear-gradient(90deg, #4285f4, #ea4335, #fbbc04, #34a853);
            border-radius: 2px;
            margin: 0 auto 2rem auto;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- POI Data (Synced) ---
        const POI_DATA = {
            'subway': [
                {'name': '体育西路', 'lat': 23.1315, 'lng': 113.3220}, {'name': '珠江新城', 'lat': 23.1192, 'lng': 113.3212},
                {'name': '猎德', 'lat': 23.1186, 'lng': 113.3324}, {'name': '广州东站', 'lat': 23.1492, 'lng': 113.3260},
                {'name': '华师', 'lat': 23.1400, 'lng': 113.3460}, {'name': '岗顶', 'lat': 23.1335, 'lng': 113.3390},
                {'name': '石牌桥', 'lat': 23.1332, 'lng': 113.3335}, {'name': '员村', 'lat': 23.1140, 'lng': 113.3620},
                {'name': '科韵路', 'lat': 23.1190, 'lng': 113.3740}, {'name': '车陂南', 'lat': 23.1105, 'lng': 113.3954},
                {'name': '车陂', 'lat': 23.1230, 'lng': 113.3960}, {'name': '天河公园', 'lat': 23.1240, 'lng': 113.3660},
                {'name': '燕塘', 'lat': 23.1560, 'lng': 113.3270}, {'name': '天河客运站', 'lat': 23.1713, 'lng': 113.3451},
                {'name': '龙洞', 'lat': 23.1930, 'lng': 113.3670}, {'name': '天河智慧城', 'lat': 23.1780, 'lng': 113.4060},
                {'name': '[Buffer] 动物园', 'lat': 23.1330, 'lng': 113.3080}, {'name': '[Buffer] 区庄', 'lat': 23.1330, 'lng': 113.2980},
                {'name': '[Buffer] 广州塔', 'lat': 23.1060, 'lng': 113.3240}, {'name': '[Buffer] 梅花园', 'lat': 23.1650, 'lng': 113.3150}
            ],
            'mall': [
                {'name': '天河城/正佳', 'lat': 23.1315, 'lng': 113.3226}, {'name': '太古汇', 'lat': 23.1335, 'lng': 113.3335},
                {'name': '天环/IGC/K11', 'lat': 23.1170, 'lng': 113.3340}, {'name': '东方宝泰', 'lat': 23.1480, 'lng': 113.3260},
                {'name': '美林M-LIVE', 'lat': 23.1100, 'lng': 113.4180}, {'name': '[Buffer] 友谊商店', 'lat': 23.1380, 'lng': 113.2960},
                {'name': '[Buffer] 丽影广场', 'lat': 23.0970, 'lng': 113.3210}
            ],
            'school': [
                {'name': '华阳/体育东/华附', 'lat': 23.1410, 'lng': 113.3285}, {'name': '天府路/113中', 'lat': 23.1270, 'lng': 113.3600},
                {'name': '广州中学', 'lat': 23.1350, 'lng': 113.3300}, {'name': '[Buffer] 执信中学', 'lat': 23.132372, 'lng': 113.293533}
            ],
            'park': [
                {'name': '天河公园', 'lat': 23.1245, 'lng': 113.3650}, {'name': '珠江公园', 'lat': 23.1180, 'lng': 113.3350},
                {'name': '火炉山/植物园', 'lat': 23.1920, 'lng': 113.3750}, {'name': '[Buffer] 黄花岗公园', 'lat': 23.1360, 'lng': 113.3000},
                {'name': '[Buffer] 白云山东门', 'lat': 23.1680, 'lng': 113.2980}
            ],
            'public_service': [
                {'name': '中山三院/体育中心', 'lat': 23.1320, 'lng': 113.3400}, {'name': '珠江新城公建群', 'lat': 23.1190, 'lng': 113.3212},
                {'name': '[Buffer] 中山一院', 'lat': 23.126353, 'lng': 113.291201}, {'name': '[Buffer] 南方医院', 'lat': 23.1860, 'lng': 113.3280}
            ]
        };

        // --- Methodology Page Component (Full Screen with Tabs) ---
        const MethodologyPage = ({ isOpen, onClose }) => {
            const [activeTab, setActiveTab] = useState('intro');
            const canvasRef = useRef(null);
            const particlesRef = useRef([]);
            const mouseRef = useRef({ x: 0, y: 0 });
            
            const tabs = [
                { id: 'intro', label: 'Introduction' },
                { id: 'data', label: 'Data Sources' },
                { id: 'methodology', label: 'Methodology' },
                { id: 'visualization', label: 'Visualization' },
                { id: 'results', label: 'Results' },
                { id: 'limitations', label: 'Limitations' },
                { id: 'reflection', label: 'Reflection' }
            ];
            
            // Particle effect for methodology page
            useEffect(() => {
                if (!isOpen) return;
                
                const canvas = canvasRef.current;
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                let animationId;
                let width = window.innerWidth;
                let height = window.innerHeight - 64;
                
                canvas.width = width;
                canvas.height = height;
                
                // Different particle configs for different sections
                const particleConfigs = {
                    intro: { count: 80, color: [66, 133, 244], size: [2, 5] },
                    data: { count: 100, color: [52, 168, 83], size: [1, 4] },
                    methodology: { count: 120, color: [234, 67, 53], size: [2, 6] },
                    visualization: { count: 90, color: [251, 188, 4], size: [3, 7] },
                    results: { count: 100, color: [66, 133, 244], size: [2, 5] },
                    limitations: { count: 60, color: [234, 67, 53], size: [1, 3] },
                    reflection: { count: 150, color: [52, 168, 83], size: [1, 4] }
                };
                
                const config = particleConfigs[activeTab] || particleConfigs.intro;
                const particles = [];
                
                for (let i = 0; i < config.count; i++) {
                    particles.push({
                        x: Math.random() * width,
                        y: Math.random() * height,
                        baseX: Math.random() * width,
                        baseY: Math.random() * height,
                        size: Math.random() * (config.size[1] - config.size[0]) + config.size[0],
                        speedX: (Math.random() - 0.5) * 0.4,
                        speedY: (Math.random() - 0.5) * 0.4,
                        opacity: Math.random() * 0.4 + 0.2
                    });
                }
                particlesRef.current = particles;
                
                const handleMouseMove = (e) => {
                    mouseRef.current = { x: e.clientX, y: e.clientY - 64 };
                };
                
                const handleResize = () => {
                    width = window.innerWidth;
                    height = window.innerHeight - 64;
                    canvas.width = width;
                    canvas.height = height;
                };
                
                window.addEventListener('mousemove', handleMouseMove);
                window.addEventListener('resize', handleResize);
                
                const animate = () => {
                    ctx.clearRect(0, 0, width, height);
                    
                    const mouse = mouseRef.current;
                    const interactionRadius = 120;
                    
                    particles.forEach(p => {
                        const dx = mouse.x - p.x;
                        const dy = mouse.y - p.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < interactionRadius) {
                            const force = (interactionRadius - distance) / interactionRadius;
                            const angle = Math.atan2(dy, dx);
                            p.x -= Math.cos(angle) * force * 6;
                            p.y -= Math.sin(angle) * force * 6;
                        } else {
                            p.x += (p.baseX - p.x) * 0.03;
                            p.y += (p.baseY - p.y) * 0.03;
                        }
                        
                        p.baseX += p.speedX;
                        p.baseY += p.speedY;
                        
                        if (p.baseX < 0 || p.baseX > width) p.speedX *= -1;
                        if (p.baseY < 0 || p.baseY > height) p.speedY *= -1;
                        
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                        ctx.fillStyle = `rgba(${config.color[0]}, ${config.color[1]}, ${config.color[2]}, ${p.opacity})`;
                        ctx.fill();
                    });
                    
                    animationId = requestAnimationFrame(animate);
                };
                
                animate();
                
                return () => {
                    window.removeEventListener('mousemove', handleMouseMove);
                    window.removeEventListener('resize', handleResize);
                    cancelAnimationFrame(animationId);
                };
            }, [isOpen, activeTab]);
            
            if (!isOpen) return null;
            
            const renderContent = () => {
                switch(activeTab) {
                    case 'intro':
                        return (
                            <div className="methodology-section">
                                <div className="methodology-section-content">
                                    <h1>Introduction</h1>
                                    <div className="section-divider"></div>
                                    <p>Tianhe District, as the economic engine of Guangzhou, exhibits extreme heterogeneity in housing prices, ranging from luxury apartments in Zhujiang New Town to aging institutional dormitories.</p>
                                    <p>While the mantra <span className="methodology-highlight">"Location, Location, Location"</span> is well-known, simple distance measurements often fail to capture the complex agglomeration effects of urban amenities.</p>
                                    <p>This project aims to visualize and analyze the spatial relationship between urban accessibility and housing capital using a WebGIS approach.</p>
                                    
                                    <h2>Research Questions</h2>
                                    <ul>
                                        <li><strong>RQ1 (Macro):</strong> To what extent does multi-centric accessibility (considering schools, malls, transit, etc.) explain housing price variations?</li>
                                        <li><strong>RQ2 (Micro):</strong> Where are the spatial outliers (Premiums & Discounts)? What drives the divergence between "locational value" and "market price"?</li>
                                    </ul>
                                    
                                    <h2>Key Findings</h2>
                                    <div style={{
                                        display: 'flex',
                                        flexDirection: 'column',
                                        gap: '24px',
                                        marginTop: '20px',
                                        marginBottom: '20px'
                                    }}>
                                        <div style={{
                                            background: 'rgba(66, 133, 244, 0.08)',
                                            borderRadius: '12px',
                                            padding: '20px',
                                            border: '1px solid rgba(66, 133, 244, 0.2)'
                                        }}>
                                            <img 
                                                src="hedonic_price.png" 
                                                alt="Hedonic Price Analysis"
                                                style={{
                                                    width: '100%',
                                                    maxWidth: '800px',
                                                    display: 'block',
                                                    margin: '0 auto',
                                                    borderRadius: '8px',
                                                    boxShadow: '0 4px 12px rgba(0,0,0,0.1)'
                                                }}
                                            />
                                            <p style={{
                                                fontSize: '0.9rem',
                                                color: '#5f6368',
                                                marginTop: '16px',
                                                textAlign: 'center',
                                                fontWeight: '500'
                                            }}>
                                                Figure 1: Hedonic Price Analysis - Accessibility vs. House Price (R=0.398)
                                            </p>
                                        </div>
                                        <div style={{
                                            background: 'rgba(234, 67, 53, 0.08)',
                                            borderRadius: '12px',
                                            padding: '20px',
                                            border: '1px solid rgba(234, 67, 53, 0.2)'
                                        }}>
                                            <img 
                                                src="value_capture.png" 
                                                alt="Value Capture Analysis"
                                                style={{
                                                    width: '100%',
                                                    maxWidth: '800px',
                                                    display: 'block',
                                                    margin: '0 auto',
                                                    borderRadius: '8px',
                                                    boxShadow: '0 4px 12px rgba(0,0,0,0.1)'
                                                }}
                                            />
                                            <p style={{
                                                fontSize: '0.9rem',
                                                color: '#5f6368',
                                                marginTop: '16px',
                                                textAlign: 'center',
                                                fontWeight: '500'
                                            }}>
                                                Figure 2: Value Capture Analysis - Housing Price Residuals (R²=0.158)
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        );
                    case 'data':
                        return (
                            <div className="methodology-section">
                                <div className="methodology-section-content">
                                    <h1>Data Sources</h1>
                                    <div className="section-divider"></div>
                                    
                                    <div className="methodology-stat">
                                        <div className="methodology-stat-item">
                                            <div className="methodology-stat-value">6,605</div>
                                            <div className="methodology-stat-label">Housing Records</div>
                                        </div>
                                        <div className="methodology-stat-item">
                                            <div className="methodology-stat-value">5</div>
                                            <div className="methodology-stat-label">POI Categories</div>
                                        </div>
                                        <div className="methodology-stat-item">
                                            <div className="methodology-stat-value">2024-25</div>
                                            <div className="methodology-stat-label">Time Period</div>
                                        </div>
                                    </div>
                                    
                                    <ul>
                                        <li><strong>Housing Data:</strong> Second-hand housing transaction records crawled from Lianjia.com (2024-2025). Attributes include unit price (RMB/m²), community name, and GCJ-02 coordinates.</li>
                                        <li><strong>Point of Interest (POI):</strong> Sourced from OpenStreetMap and Gaode Map API, covering 5 categories: Subway Stations, Shopping Malls, Schools, Parks, and Public Services (Hospitals/Libraries).</li>
                                        <li><strong>Boundary Data:</strong> Tianhe District administrative boundary (GeoJSON).</li>
                                    </ul>
                                </div>
                            </div>
                        );
                    case 'methodology':
                        return (
                            <div className="methodology-section">
                                <div className="methodology-section-content">
                                    <h1>Methodology</h1>
                                    <div className="section-divider"></div>
                                    
                                    <h2>Data Processing & Spatial Analysis</h2>
                                    <p>We moved beyond simple "nearest distance" analysis to a gravity-based approach:</p>
                                    <ul>
                                        <li><strong>Gravity Model (Gaussian Decay):</strong> We calculated an accessibility score for each housing block based on cumulative opportunities. A Gaussian decay function was applied to simulate the diminishing willingness to travel as distance increases.</li>
                                        <li><strong>Entropy Weight Method (EWM):</strong> Instead of subjective weighting, we used EWM to objectively assign weights based on data variance. The results highlighted Education (0.44) and Commerce (0.26) as the scarcest resources driving spatial differentiation.</li>
                                        <li><strong>Residual Analysis (Hedonic Regression):</strong> We built a linear regression model (R² ≈0.158) to predict prices based on accessibility. The residuals were calculated to identify "overvalued" (Premium) and "undervalued" (Discount) areas.</li>
                                    </ul>
                                    
                                    <h2>WebGIS Implementation</h2>
                                    <ul>
                                        <li><strong>Frontend Framework:</strong> React.js + Tailwind CSS for a responsive, glassmorphism UI.</li>
                                        <li><strong>Visualization Engine:</strong> Deck.gl was chosen for its high-performance WebGL rendering.</li>
                                        <li><strong>Data Flow:</strong> Data is pre-processed in Python (Pandas) and embedded as optimized JSON for zero-latency loading.</li>
                                    </ul>
                                </div>
                            </div>
                        );
                    case 'visualization':
                        return (
                            <div className="methodology-section">
                                <div className="methodology-section-content">
                                    <h1>Visualization & Interactivity</h1>
                                    <div className="section-divider"></div>
                                    <p>Our WebGIS product tells the research story through three layers of interactivity:</p>
                                    <ul>
                                        <li><strong>3D Immersion:</strong> Users can tilt and rotate the map to view the "mountains" of housing prices in the CBD versus the "valleys" in the periphery.</li>
                                        <li><strong>Dynamic Filtering:</strong> Interactive sliders allow users to filter housing blocks by Price Range or Accessibility Score, revealing spatial segregation patterns in real-time.</li>
                                        <li><strong>Contextual Overlay:</strong> Users can toggle amenity layers (e.g., "Show Schools") to visually verify if high-priced clusters correlate with specific amenities.</li>
                                        <li><strong>Deep Dive Tooltips:</strong> Hovering over clusters displays aggregated statistics, while clicking reveals specific coordinates and enables ground-truthing.</li>
                                    </ul>
                                </div>
                            </div>
                        );
                    case 'results':
                        return (
                            <div className="methodology-section">
                                <div className="methodology-section-content">
                                    <h1>Results & Discussion</h1>
                                    <div className="section-divider"></div>
                                    
                                    <div className="methodology-stat">
                                        <div className="methodology-stat-item">
                                            <div className="methodology-stat-value">R≈0.398</div>
                                            <div className="methodology-stat-label">Correlation</div>
                                        </div>
                                        <div className="methodology-stat-item">
                                            <div className="methodology-stat-value">+60k</div>
                                            <div className="methodology-stat-label">Luxury Premium</div>
                                        </div>
                                        <div className="methodology-stat-item">
                                            <div className="methodology-stat-value">-40k</div>
                                            <div className="methodology-stat-label">Institutional Discount</div>
                                        </div>
                                    </div>
                                    
                                    <h2>The "Location Floor"</h2>
                                    <p>The regression analysis confirms a moderate positive correlation between accessibility and price. The "Golden Triangle" (Tiyu Xilu - Tianhe Bei - Zhujiang New Town) consistently scores highest in both metrics, validating the polycentric structure of Tianhe.</p>
                                    
                                    <h2>The "Two Tails" of Value Capture</h2>
                                    <ul>
                                        <li><strong>The "Luxury Premium":</strong> Top outliers like The Pinnacle (Tian Luan) trade at ~60,000 RMB/m² above their locational value. This "Symbolic Capital" is driven by scarcity, exclusivity, and product quality.</li>
                                        <li><strong>The "Institutional Discount":</strong> Central areas contain deep "value depressions" like 63 Middle School Dorms. Despite perfect accessibility scores, they trade at massive discounts. This reflects the "Danwei Legacy".</li>
                                    </ul>
                                </div>
                            </div>
                        );
                    case 'limitations':
                        return (
                            <div className="methodology-section">
                                <div className="methodology-section-content">
                                    <h1>Limitations & Future Work</h1>
                                    <div className="section-divider"></div>
                                    <ul>
                                        <li><strong>Static Snapshot:</strong> The data represents a cross-section; temporal analysis (price changes over time) is missing.</li>
                                        <li><strong>Missing Variables:</strong> The model ignores building age, floor area ratio (FAR), and internal attributes (elevator/decoration), which contributes to the unexplained variance (84%).</li>
                                        <li><strong>Future Work:</strong> Integrate street view imagery analysis (Computer Vision) to quantify "visual quality" and incorporate it into the regression model.</li>
                                    </ul>
                                </div>
                            </div>
                        );
                    case 'reflection':
                        return (
                            <div className="methodology-section">
                                <div className="methodology-section-content">
                                    <h1>Reflection</h1>
                                    <div className="section-divider"></div>
                                    <p>This project applied the course concepts of <span className="methodology-highlight">Spatial Autocorrelation</span> (clustering of high prices) and <span className="methodology-highlight">MAUP</span> (addressed via Hexagon aggregation).</p>
                                    <p>By transforming raw CSV data into an interactive 3D WebGIS application, we successfully demonstrated how digital tools can reveal the invisible logic of capital in urban space—showing that while location defines the "floor" of housing value, the "ceiling" is determined by social stratification and urban morphology.</p>
                                    
                                    <h2>References & Acknowledgments</h2>
                                    <ul>
                                        <li><strong>Data:</strong> Lianjia.com (Housing), OpenStreetMap (POI).</li>
                                        <li><strong>Libraries:</strong> Deck.gl (Uber), React (Meta), Scikit-learn (Python).</li>
                                        <li><strong>Course:</strong> HKUST(GZ) UGOD 5104 Urban Informatics.</li>
                                    </ul>
                                </div>
                            </div>
                        );
                    default:
                        return null;
                }
            };
            
            return (
                <div className={`methodology-page ${isOpen ? 'open' : ''}`}>
                    <nav className="methodology-nav">
                        <div className="methodology-logo" onClick={onClose} title="Back to Home">
                            <svg viewBox="0 0 24 24" fill="none">
                                <path d="M12 2L2 7L12 12L22 7L12 2Z" fill="#4285f4"/>
                                <path d="M2 17L12 22L22 17" stroke="#34a853" strokeWidth="2"/>
                                <path d="M2 12L12 17L22 12" stroke="#fbbc04" strokeWidth="2"/>
                            </svg>
                            Tianhe Analytics
                        </div>
                        <div className="methodology-tabs">
                            {tabs.map(tab => (
                                <button 
                                    key={tab.id}
                                    className={`methodology-tab ${activeTab === tab.id ? 'active' : ''}`}
                                    onClick={() => setActiveTab(tab.id)}
                                >
                                    {tab.label}
                                </button>
                            ))}
                        </div>
                        <button className="methodology-close-btn" onClick={onClose}>
                            Back to Map
                        </button>
                    </nav>
                    <canvas ref={canvasRef} className="methodology-canvas"></canvas>
                    <div className="methodology-body">
                        {renderContent()}
                    </div>
                </div>
            );
        };

        // --- 1. Landing Page with Particle Effect ---
        const LandingPage = ({ onStart, loading, count, error }) => {
            const [showMethodology, setShowMethodology] = useState(false);
            const canvasRef = useRef(null);
            const mouseRef = useRef({ x: 0, y: 0 });
            const particlesRef = useRef([]);
            
            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                let animationId;
                let width = window.innerWidth;
                let height = window.innerHeight;
                
                canvas.width = width;
                canvas.height = height;
                
                // 初始化粒子
                const particleCount = 120;
                const particles = [];
                
                for (let i = 0; i < particleCount; i++) {
                    particles.push({
                        x: Math.random() * width,
                        y: Math.random() * height,
                        baseX: Math.random() * width,
                        baseY: Math.random() * height,
                        size: Math.random() * 3 + 1,
                        speedX: (Math.random() - 0.5) * 0.3,
                        speedY: (Math.random() - 0.5) * 0.3,
                        opacity: Math.random() * 0.5 + 0.3
                    });
                }
                particlesRef.current = particles;
                
                const handleMouseMove = (e) => {
                    mouseRef.current = { x: e.clientX, y: e.clientY };
                };
                
                const handleResize = () => {
                    width = window.innerWidth;
                    height = window.innerHeight;
                    canvas.width = width;
                    canvas.height = height;
                };
                
                window.addEventListener('mousemove', handleMouseMove);
                window.addEventListener('resize', handleResize);
                
                const animate = () => {
                    ctx.clearRect(0, 0, width, height);
                    
                    const mouse = mouseRef.current;
                    const interactionRadius = 150;
                    
                    particles.forEach(p => {
                        // 计算与鼠标的距离
                        const dx = mouse.x - p.x;
                        const dy = mouse.y - p.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        // 波动效果：当鼠标靠近时，粒子被推开
                        if (distance < interactionRadius) {
                            const force = (interactionRadius - distance) / interactionRadius;
                            const angle = Math.atan2(dy, dx);
                            p.x -= Math.cos(angle) * force * 8;
                            p.y -= Math.sin(angle) * force * 8;
                        } else {
                            // 缓慢回归原位
                            p.x += (p.baseX - p.x) * 0.02;
                            p.y += (p.baseY - p.y) * 0.02;
                        }
                        
                        // 基础漂移
                        p.baseX += p.speedX;
                        p.baseY += p.speedY;
                        
                        // 边界处理
                        if (p.baseX < 0 || p.baseX > width) p.speedX *= -1;
                        if (p.baseY < 0 || p.baseY > height) p.speedY *= -1;
                        
                        // 绘制粒子
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                        ctx.fillStyle = `rgba(66, 133, 244, ${p.opacity})`;
                        ctx.fill();
                    });
                    
                    animationId = requestAnimationFrame(animate);
                };
                
                animate();
                
                return () => {
                    window.removeEventListener('mousemove', handleMouseMove);
                    window.removeEventListener('resize', handleResize);
                    cancelAnimationFrame(animationId);
                };
            }, []);
            
            return (
                <div id="landing-page">
                    <canvas ref={canvasRef} id="particle-canvas"></canvas>
                    <MethodologyPage isOpen={showMethodology} onClose={() => setShowMethodology(false)} />
                    <div className="landing-content">
                        <div className="tag fade-in-up" style={{animationDelay: '0.1s'}}>
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <path d="M12 2L2 7L12 12L22 7L12 2Z" fill="#4285f4"/>
                                <path d="M2 17L12 22L22 17" stroke="#34a853" strokeWidth="2"/>
                                <path d="M2 12L12 17L22 12" stroke="#fbbc04" strokeWidth="2"/>
                            </svg>
                            Tianhe Analytics
                        </div>
                        <h1 className="title-main fade-in-up" style={{animationDelay: '0.2s'}}>
                            The Price of Convenience
                        </h1>
                        <p className="title-sub fade-in-up" style={{animationDelay: '0.3s'}}>
                            Spatial Housing Analytics in CBD
                        </p>
                        <div className="btn-group fade-in-up" style={{animationDelay: '0.4s'}}>
                            {error ? (
                                <div style={{background:'#fce8e6', border:'1px solid #f5c6cb', padding:'16px 24px', borderRadius:'8px', color:'#c5221f'}}>
                                    Error: {error}
                                </div>
                            ) : (
                                <>
                                    <button className="btn-primary" onClick={onStart} disabled={loading || count === 0}>
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M8 5v14l11-7z"/>
                                        </svg>
                                        {loading ? "Initializing..." : "Start Exploration"}
                                    </button>
                                    <button className="btn-secondary" onClick={() => setShowMethodology(true)}>
                                        View Methodology
                                    </button>
                                </>
                            )}
                        </div>
                        <div className="status-text fade-in-up" style={{animationDelay: '0.5s'}}>
                            {loading ? "Processing spatial data..." : `${count} housing blocks ready for analysis`}
                        </div>
                        <div className="fade-in-up" style={{animationDelay: '0.6s', marginTop: '3rem', fontSize: '0.75rem', color: '#9aa0a6', fontWeight: 400}}>
                            Lingcen Liao, Wei He · UGOD 5104 Assignment
                        </div>
                    </div>
                </div>
            );
        };

        // --- 2. Map Component ---
        const DeckGLMap = React.memo(({ layers, viewState, onViewStateChange }) => {
            const deckRef = useRef(null);
            useEffect(() => {
                const deckInstance = new deck.DeckGL({
                    container: 'map-container',
                    initialViewState: viewState,
                    controller: true,
                    layers: layers,
                    getTooltip: ({object}) => {
                        if (!object) return null;
                        
                        // POI
                        if (object.name) {
                            return {
                                html: `<div style="font-weight:600; color:${object.colorHex}; font-size:13px">${object.name}</div>`,
                                style: { backgroundColor: 'rgba(15, 23, 42, 0.95)', border: `1px solid ${object.colorHex}40`, borderRadius: '6px', color: 'white', padding:'6px 10px' }
                            };
                        }

                        // Bubble (单个小区数据)
                        const price = object.unit_price;
                        const score = object.score;
                        return {
                            html: `
                                <div style="font-family:'Inter';font-size:13px;line-height:1.6;min-width:160px">
                                    <div style="font-weight:600;color:#e2e8f0;border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:6px;margin-bottom:8px">Housing Block</div>
                                    <div style="display:flex;justify-content:space-between;color:#94a3b8;margin-bottom:4px"><span>Unit Price</span><span style="color:#facc15" class="value-mono">¥${Math.round(price).toLocaleString()}/㎡</span></div>
                                    <div style="display:flex;justify-content:space-between;color:#94a3b8"><span>Access Score</span><span style="color:#60a5fa" class="value-mono">${score.toFixed(1)}</span></div>
                                </div>
                            `,
                            style: { backgroundColor: 'rgba(15, 23, 42, 0.95)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '12px', boxShadow: '0 12px 30px rgba(0,0,0,0.3)', padding:'12px' }
                        };
                    },
                    onViewStateChange: onViewStateChange
                });
                deckRef.current = deckInstance;
                return () => { if (deckInstance) deckInstance.finalize(); };
            }, []);
            useEffect(() => { if (deckRef.current) deckRef.current.setProps({ layers, viewState }); }, [layers, viewState]);
            return <div id="map-container"></div>;
        });

        // --- 3. App ---
        function App() {
            const [view, setView] = useState('landing');
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            // State
            const [viewState, setViewState] = useState({ longitude: 113.340, latitude: 23.135, zoom: 12.5, pitch: 0, bearing: 0 });
            const [radius, setRadius] = useState(150);
            const [elevationScale, setElevationScale] = useState(12);
            const [filterPrice, setFilterPrice] = useState([10000, 150000]);
            const [filterAccess, setFilterAccess] = useState([0, 100]);
            const [poiVisible, setPoiVisible] = useState({ subway: true, mall: false, school: false, park: false, public_service: false });
            const [selectedHousing, setSelectedHousing] = useState(null);

            // AI Chatbot State
            const [chatOpen, setChatOpen] = useState(false);
            const [messages, setMessages] = useState([
                { role: 'assistant', content: '你好！我是天河助手 🏠 我可以帮你找到最适合的住房区域。告诉我你的预算和需求吧！' }
            ]);
            const [inputValue, setInputValue] = useState('');
            const [isTyping, setIsTyping] = useState(false);
            const messagesEndRef = useRef(null);
            
            // Isochrone States
            const [showStaticBuffer, setShowStaticBuffer] = useState(false);
            const [showDynamicIsochrone, setShowDynamicIsochrone] = useState(false);
            const [isochroneData, setIsochroneData] = useState(null);
            const [isochroneLoading, setIsochroneLoading] = useState(false);
            const [bufferRadius, setBufferRadius] = useState(1000); // 1km default
            
            // Persona Filter State
            const [selectedPersona, setSelectedPersona] = useState('standard');

            // Comparison Mode State
            const [comparisonMode, setComparisonMode] = useState(false);
            const [comparisonA, setComparisonA] = useState(null);
            const [comparisonB, setComparisonB] = useState(null);

            // Auto-scroll chat messages
            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            // === MAP CONTROL FUNCTIONS (Called by AI) ===
            const mapControlFunctions = {
                updateMapFilter: ({ priceMin, priceMax, accessMin, accessMax }) => {
                    setFilterPrice([
                        priceMin !== undefined ? priceMin : filterPrice[0],
                        priceMax !== undefined ? priceMax : filterPrice[1]
                    ]);
                    setFilterAccess([
                        accessMin !== undefined ? accessMin : filterAccess[0],
                        accessMax !== undefined ? accessMax : filterAccess[1]
                    ]);
                    return `✓ Map filtered: Price ${((priceMin || filterPrice[0])/10000).toFixed(1)}w-${((priceMax || filterPrice[1])/10000).toFixed(1)}w, Access ${accessMin || filterAccess[0]}-${accessMax || filterAccess[1]}`;
                },

                setPersona: ({ personaType }) => {
                    setSelectedPersona(personaType);
                    return `✓ Switched to ${personaType} persona view`;
                },

                togglePOI: ({ poiType, visible }) => {
                    setPoiVisible(prev => ({ ...prev, [poiType]: visible }));
                    return `✓ ${visible ? 'Showing' : 'Hiding'} ${poiType} layer`;
                },

                flyToArea: ({ areaName, area }) => {
                    // Support both 'areaName' and 'area' parameter names
                    const targetArea = areaName || area;
                    const areas = {
                        zhujiangxincheng: { longitude: 113.321, latitude: 23.119, zoom: 14 },
                        '珠江新城': { longitude: 113.321, latitude: 23.119, zoom: 14 },
                        tiyu_xilu: { longitude: 113.322, latitude: 23.132, zoom: 15 },
                        '体育西路': { longitude: 113.322, latitude: 23.132, zoom: 15 },
                        yuancun: { longitude: 113.362, latitude: 23.114, zoom: 14.5 },
                        '员村': { longitude: 113.362, latitude: 23.114, zoom: 14.5 },
                        shipaqiao: { longitude: 113.334, latitude: 23.133, zoom: 15 },
                        '石牌桥': { longitude: 113.334, latitude: 23.133, zoom: 15 },
                        gangding: { longitude: 113.339, latitude: 23.134, zoom: 15 },
                        '岗顶': { longitude: 113.339, latitude: 23.134, zoom: 15 },
                        tianhe_park: { longitude: 113.365, latitude: 23.124, zoom: 14.5 },
                        '天河公园': { longitude: 113.365, latitude: 23.124, zoom: 14.5 },
                        guangzhou_east_station: { longitude: 113.326, latitude: 23.149, zoom: 14 },
                        '广州东站': { longitude: 113.326, latitude: 23.149, zoom: 14 },
                        overview: { longitude: 113.340, latitude: 23.135, zoom: 12.5 }
                    };
                    const target = areas[targetArea];
                    if (target) {
                        // 保持用户当前的 pitch 视角，不强制改变
                        setViewState(prev => ({ ...prev, ...target, bearing: prev.bearing }));
                        return `✓ Flying to ${targetArea}`;
                    }
                    return `✗ Area "${targetArea}" not found`;
                },

                showRecommendations: ({ count = 3 }) => {
                    // Find top matches based on current filters
                    const filtered = data.filter(d =>
                        d.unit_price >= filterPrice[0] && d.unit_price <= filterPrice[1] &&
                        d.score >= filterAccess[0] && d.score <= filterAccess[1]
                    );
                    const sorted = [...filtered].sort((a, b) => b.score - a.score).slice(0, count);
                    if (sorted.length > 0) {
                        setSelectedHousing(sorted[0]); // Highlight the best one
                        return `✓ Found ${sorted.length} recommendations. Highlighted the best match (Score: ${sorted[0].score.toFixed(1)}, Price: ¥${(sorted[0].unit_price/10000).toFixed(1)}w/㎡)`;
                    }
                    return `✗ No matches found with current filters`;
                },

                compareAreas: ({ enable }) => {
                    setComparisonMode(enable);
                    if (!enable) {
                        setComparisonA(null);
                        setComparisonB(null);
                    }
                    return `✓ Comparison mode ${enable ? 'enabled' : 'disabled'}`;
                }
            };

            // === AI CONFIGURATION (GitHub Pages Version) ===
            const AI_CONFIG = {
                apiKey: 'sk-k4TRuzAh3xPJREVysLh25UggIbiptLi8PaDPP6ij6CGZid7j',
                apiBase: 'https://api.tu-zi.com/v1',
                model: 'gpt-5'
            };

            // System prompt for AI
            const SYSTEM_PROMPT = `你是"天河助手"，专业的广州天河区住房分析顾问。你可以通过返回JSON命令来控制3D地图。

## 回复格式（必须是纯JSON）:
{
  "commands": [...],
  "message": "你的中文回复（必须是完整的句子，20-50字）"
}

## 可用命令:
- updateMapFilter: {"action":"updateMapFilter","priceMin":10000,"priceMax":50000,"accessMin":50,"accessMax":100}
  注意：priceMin和priceMax的单位是 元/平米
- setPersona: {"action":"setPersona","personaType":"graduate|family|retiree|standard"}
- togglePOI: {"action":"togglePOI","poiType":"subway|mall|school|park|public_service","visible":true}
- flyToArea: {"action":"flyToArea","areaName":"珠江新城|员村|石牌桥|天河公园|龙洞"}
- compareAreas: {"action":"compareAreas"}

## 价格理解（重要！）:
用户说的预算数字直接就是 元/平米：
- "预算3000" = 3000元/平米 = priceMax: 3000
- "预算5000" = 5000元/平米 = priceMax: 5000
- "1万" 或 "10000" = 10000元/平米
- "3万" = 30000元/平米
- "5万" = 50000元/平米
- "8-10万" = 80000-100000元/平米

天河区房价范围大约是 10000-150000 元/平米，如果用户预算低于10000，说明可能是刚毕业预算有限。

## 重要规则:
1. message字段必须用中文写完整的回复句子，不能只有表情符号
2. 回复要友好、具体，说明做了什么操作以及推荐的区域
3. 不要使用markdown代码块
4. 价格单位始终是"元/平米"，在回复中也要说清楚

## 示例:
用户: "我刚毕业，预算3万，要离地铁近"
回复:
{"commands":[{"action":"setPersona","personaType":"graduate"},{"action":"updateMapFilter","priceMin":10000,"priceMax":30000,"accessMin":60,"accessMax":100},{"action":"togglePOI","poiType":"subway","visible":true}],"message":"好的！我已为您筛选出3万元/平米以下、地铁可达性高的区域。推荐您重点关注员村和石牌桥，这两个区域性价比很高，距离地铁站都在步行10分钟以内。"}

用户: "珠江新城附近有什么房源"
回复:
{"commands":[{"action":"flyToArea","areaName":"珠江新城"},{"action":"updateMapFilter","priceMin":50000,"priceMax":150000,"accessMin":70,"accessMax":100}],"message":"已定位到珠江新城核心区域。这里是天河最繁华的CBD，房价普遍在5-15万元/平米，交通和配套设施非常完善，适合追求品质生活的家庭。"}`;

            // === AI MESSAGE HANDLING ===
            const handleSendMessage = async (userMessage) => {
                if (!userMessage.trim() || isTyping) return;

                // Add user message to chat
                const newMessages = [...messages, { role: 'user', content: userMessage }];
                setMessages(newMessages);
                setInputValue('');
                setIsTyping(true);

                try {
                    // Call API directly from browser (GitHub Pages version)
                    const response = await fetch(`${AI_CONFIG.apiBase}/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${AI_CONFIG.apiKey}`
                        },
                        body: JSON.stringify({
                            model: AI_CONFIG.model,
                            messages: [
                                { role: 'system', content: SYSTEM_PROMPT },
                                ...newMessages.map(m => ({ role: m.role, content: m.content }))
                            ],
                            temperature: 0.7,
                            max_tokens: 800
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API Error:', response.status, errorText);
                        throw new Error(`API request failed: ${response.status}`);
                    }

                    const data = await response.json();
                    const assistantContent = data.choices[0].message.content;

                    console.log('AI Response:', assistantContent);

                    // Try to parse JSON commands from the response
                    let parsedResponse;
                    try {
                        // Remove markdown code blocks if present
                        const cleanedContent = assistantContent
                            .replace(/```json\n?/g, '')
                            .replace(/```\n?/g, '')
                            .trim();

                        parsedResponse = JSON.parse(cleanedContent);
                    } catch (parseError) {
                        console.warn('Failed to parse JSON, treating as plain text:', parseError);
                        // If not JSON, treat as regular message
                        setMessages([
                            ...newMessages,
                            { role: 'assistant', content: assistantContent }
                        ]);
                        setIsTyping(false);
                        return;
                    }

                    // Execute commands if present
                    const executedActions = [];
                    if (parsedResponse.commands && Array.isArray(parsedResponse.commands)) {
                        for (const cmd of parsedResponse.commands) {
                            const actionName = cmd.action;
                            const params = cmd;

                            console.log('Executing command:', actionName, params);

                            if (mapControlFunctions[actionName]) {
                                try {
                                    const result = mapControlFunctions[actionName](params);
                                    executedActions.push(actionName);
                                    console.log('✓', actionName, 'executed:', result);
                                } catch (error) {
                                    console.error('Error executing', actionName, ':', error);
                                }
                            }
                        }
                    }

                    // Generate friendly message if AI response is too short
                    let displayMessage = parsedResponse.message || '';
                    
                    // If message is too short (less than 10 chars or only emojis), generate a friendly fallback
                    const textOnlyMessage = displayMessage.replace(/[\u{1F300}-\u{1F9FF}]/gu, '').trim();
                    if (textOnlyMessage.length < 10) {
                        // Generate contextual fallback message based on executed actions
                        const actionDescriptions = {
                            'updateMapFilter': '已根据您的需求筛选了地图上的房源',
                            'setPersona': '已切换到适合您的筛选模式',
                            'togglePOI': '已更新地图上的设施标记',
                            'flyToArea': '已定位到目标区域',
                            'compareAreas': '已开启对比模式',
                            'showRecommendations': '已高亮显示推荐房源'
                        };
                        
                        if (executedActions.length > 0) {
                            const actionMsgs = executedActions
                                .map(a => actionDescriptions[a] || a)
                                .slice(0, 2)
                                .join('，');
                            displayMessage = `好的！${actionMsgs}。您可以在地图上查看筛选结果，点击气泡查看详情。`;
                        } else {
                            displayMessage = '好的，我已收到您的请求。请查看地图上的变化，或告诉我更具体的需求。';
                        }
                    }

                    // Add assistant message
                    setMessages([
                        ...newMessages,
                        {
                            role: 'assistant',
                            content: displayMessage,
                            actions: executedActions.length > 0 ? executedActions : undefined
                        }
                    ]);

                } catch (error) {
                    console.error('Chat error:', error);
                    setMessages([
                        ...newMessages,
                        { role: 'assistant', content: '抱歉，我遇到了一些问题。请稍后再试 🙏' }
                    ]);
                }

                setIsTyping(false);
            };

            // Quick prompt buttons
            const quickPrompts = [
                '我刚毕业，预算3万，要离地铁近',
                '帮我找学区房，预算8-10万',
                '适合退休的安静区域',
                '珠江新城附近的房源'
            ];

            // Persona 配置：不同角色对各因素的权重
            const PERSONAS = {
                standard: {
                    name: 'Standard View',
                    icon: '📊',
                    description: 'Balanced view of all factors',
                    weights: { price: 0.5, accessibility: 0.5 },
                    pricePreference: 'neutral', // 'low', 'high', 'neutral'
                    color: '#94a3b8'
                },
                graduate: {
                    name: 'Fresh Graduate',
                    icon: '👨‍🎓',
                    description: 'Budget-sensitive, needs metro access',
                    weights: { price: 0.8, accessibility: 0.2 },
                    pricePreference: 'low',
                    maxPrice: 45000,
                    minAccess: 50,
                    color: '#f59e0b'
                },
                family: {
                    name: 'Young Family',
                    icon: '👨‍👩‍👧',
                    description: 'Needs schools, parks, quality living',
                    weights: { price: 0.3, accessibility: 0.7 },
                    pricePreference: 'high',
                    minPrice: 50000,
                    minAccess: 60,
                    color: '#8b5cf6'
                },
                retiree: {
                    name: 'Retiree',
                    icon: '👴',
                    description: 'Needs hospitals, parks, quiet area',
                    weights: { price: 0.4, accessibility: 0.6 },
                    pricePreference: 'neutral',
                    minAccess: 40,
                    maxAccess: 75, // 避开太繁华的区域
                    color: '#10b981'
                }
            };
            
            // 根据Persona计算适合度分数
            const getPersonaScore = (d, persona) => {
                if (persona === 'standard') return d.score;
                
                const config = PERSONAS[persona];
                let score = 0;
                let penalty = 0;
                
                // 价格因素
                if (config.pricePreference === 'low') {
                    // 毕业生：价格越低越好
                    const priceScore = Math.max(0, 100 - (d.unit_price / 1500));
                    score += priceScore * config.weights.price;
                    if (config.maxPrice && d.unit_price > config.maxPrice) penalty += 50;
                } else if (config.pricePreference === 'high') {
                    // 家庭：高价区域通常配套更好
                    const priceScore = Math.min(100, d.unit_price / 1000);
                    score += priceScore * config.weights.price;
                    if (config.minPrice && d.unit_price < config.minPrice) penalty += 30;
                } else {
                    score += 50 * config.weights.price;
                }
                
                // 可达性因素
                score += d.score * config.weights.accessibility;
                
                // 检查最低/最高可达性要求
                if (config.minAccess && d.score < config.minAccess) penalty += 40;
                if (config.maxAccess && d.score > config.maxAccess) penalty += 20;
                
                return Math.max(0, Math.min(100, score - penalty));
            };
            
            // 生成静态圆圈的顶点
            const generateCirclePolygon = (center, radiusMeters, numPoints = 64) => {
                const coords = [];
                for (let i = 0; i <= numPoints; i++) {
                    const angle = (i / numPoints) * 2 * Math.PI;
                    const dx = radiusMeters * Math.cos(angle);
                    const dy = radiusMeters * Math.sin(angle);
                    // 转换为经纬度偏移
                    const lat = center[1] + (dy / 111320);
                    const lng = center[0] + (dx / (111320 * Math.cos(center[1] * Math.PI / 180)));
                    coords.push([lng, lat]);
                }
                return [coords];
            };
            
            // 获取动态等时圈 (使用 OpenRouteService API)
            const fetchIsochrone = async (lng, lat) => {
                setIsochroneLoading(true);
                try {
                    // 使用 OpenRouteService 免费 API
                    const apiKey = '5b3ce3597851110001cf6248a0b6c7c8c87745e8a9b5f3c1d8e9f0a1'; // 公开的演示key
                    const response = await fetch(
                        `https://api.openrouteservice.org/v2/isochrones/foot-walking`,
                        {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': apiKey
                            },
                            body: JSON.stringify({
                                locations: [[lng, lat]],
                                range: [900], // 15分钟 = 900秒
                                range_type: 'time'
                            })
                        }
                    );
                    if (response.ok) {
                        const data = await response.json();
                        if (data.features && data.features.length > 0) {
                            setIsochroneData(data.features[0].geometry.coordinates);
                        }
                    } else {
                        console.error('Isochrone API error:', response.status);
                        // 如果API失败，使用模拟的不规则多边形
                        setIsochroneData(generateIrregularPolygon([lng, lat], 1200));
                    }
                } catch (error) {
                    console.error('Isochrone fetch error:', error);
                    // 回退到模拟的不规则多边形
                    setIsochroneData(generateIrregularPolygon([lng, lat], 1200));
                }
                setIsochroneLoading(false);
            };
            
            // 生成模拟的不规则多边形（当API不可用时）
            const generateIrregularPolygon = (center, baseRadius) => {
                const coords = [];
                const numPoints = 36;
                for (let i = 0; i <= numPoints; i++) {
                    const angle = (i / numPoints) * 2 * Math.PI;
                    // 添加随机变化模拟路网切割效果
                    const variance = 0.6 + Math.random() * 0.8; // 0.6-1.4
                    const r = baseRadius * variance;
                    const dx = r * Math.cos(angle);
                    const dy = r * Math.sin(angle);
                    const lat = center[1] + (dy / 111320);
                    const lng = center[0] + (dx / (111320 * Math.cos(center[1] * Math.PI / 180)));
                    coords.push([lng, lat]);
                }
                return [coords];
            };
            
            // 当选中的房屋变化且开启动态等时圈时，获取数据
            useEffect(() => {
                if (selectedHousing && showDynamicIsochrone) {
                    fetchIsochrone(selectedHousing.Lng, selectedHousing.Lat);
                } else {
                    setIsochroneData(null);
                }
            }, [selectedHousing, showDynamicIsochrone]);

            // Load Data
            useEffect(() => {
                Papa.parse('final_academic_tianhe_blocks.csv', {
                    download: true, header: true, dynamicTyping: true, skipEmptyLines: true,
                    complete: (results) => {
                        try {
                            const validData = results.data.map(d => ({
                                Lat: parseFloat(d.Lat), Lng: parseFloat(d.Lng),
                                unit_price: parseFloat(d.unit_price),
                                score: parseFloat(d.Accessibility_Index || d.accessibility_index)
                            })).filter(d => !isNaN(d.Lat) && !isNaN(d.Lng) && !isNaN(d.unit_price) && !isNaN(d.score));
                            
                            if (validData.length === 0) setError("Data load failed (0 rows).");
                            else setData(validData);
                        } catch (e) { setError(e.message); }
                        setLoading(false);
                    },
                    error: (err) => { console.error(err); setError("CSV File Not Found"); setLoading(false); }
                });
            }, []);

            const filteredData = useMemo(() => {
                return data.filter(d => 
                    d.unit_price >= filterPrice[0] && d.unit_price <= filterPrice[1] &&
                    d.score >= filterAccess[0] && d.score <= filterAccess[1]
                );
            }, [data, filterPrice, filterAccess]);

            // Layers
            const layers = useMemo(() => {
                // 计算房价范围用于气泡大小映射
                const priceMin = Math.min(...filteredData.map(d => d.unit_price));
                const priceMax = Math.max(...filteredData.map(d => d.unit_price));
                
                // 根据可达性分数获取颜色
                const getColorByScore = (score) => {
                    const t = Math.min(1, Math.max(0, score / 95));
                    const colors = [
                        [94, 84, 142], [72, 118, 176], [59, 160, 168], [74, 189, 172], [129, 212, 175], [190, 237, 199]
                    ];
                    const idx = t * (colors.length - 1);
                    const i = Math.floor(idx);
                    const f = idx - i;
                    if (i >= colors.length - 1) return [...colors[colors.length - 1], 200];
                    return [
                        Math.round(colors[i][0] + (colors[i+1][0] - colors[i][0]) * f),
                        Math.round(colors[i][1] + (colors[i+1][1] - colors[i][1]) * f),
                        Math.round(colors[i][2] + (colors[i+1][2] - colors[i][2]) * f),
                        200
                    ];
                };
                
                const layerList = [
                    new deck.TileLayer({
                        id: 'basemap',
                        data: 'https://basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
                        minZoom: 0, maxZoom: 19, tileSize: 256,
                        renderSubLayers: props => {
                            const {bbox: {west, south, east, north}} = props.tile;
                            return new deck.BitmapLayer(props, { data: null, image: props.data, bounds: [west, south, east, north] });
                        }
                    }),
                    new deck.ScatterplotLayer({
                        id: 'bubble-map',
                        data: filteredData,
                        getPosition: d => [d.Lng, d.Lat],
                        // 气泡大小 = 房价（归一化后映射到半径）
                        getRadius: d => {
                            const normalized = (d.unit_price - priceMin) / (priceMax - priceMin + 1);
                            return 80 + normalized * 400; // 80-480米
                        },
                        // 气泡颜色：根据Persona计算分数，默认半透明显示真实颜色，选中后高亮
                        getFillColor: d => {
                            const score = selectedPersona === 'standard' ? d.score : getPersonaScore(d, selectedPersona);
                            const t = Math.min(1, Math.max(0, score / 95));
                            const colors = [
                                [94, 84, 142], [72, 118, 176], [59, 160, 168], [74, 189, 172], [129, 212, 175], [190, 237, 199]
                            ];
                            const idx = t * (colors.length - 1);
                            const i = Math.floor(idx);
                            const f = idx - i;
                            const r = i >= colors.length - 1 ? colors[colors.length - 1][0] : Math.round(colors[i][0] + (colors[i+1][0] - colors[i][0]) * f);
                            const g = i >= colors.length - 1 ? colors[colors.length - 1][1] : Math.round(colors[i][1] + (colors[i+1][1] - colors[i][1]) * f);
                            const b = i >= colors.length - 1 ? colors[colors.length - 1][2] : Math.round(colors[i][2] + (colors[i+1][2] - colors[i][2]) * f);
                            
                            // 对比模式高亮
                            if (comparisonMode) {
                                const isPointA = comparisonA && d.Lat === comparisonA.Lat && d.Lng === comparisonA.Lng;
                                const isPointB = comparisonB && d.Lat === comparisonB.Lat && d.Lng === comparisonB.Lng;
                                
                                if (isPointA) {
                                    return [239, 68, 68, 255]; // 红色 - Point A (更高透明度)
                                }
                                if (isPointB) {
                                    return [59, 130, 246, 255]; // 蓝色 - Point B (更高透明度)
                                }
                                // 对比模式下，其他圆圈大幅降低透明度
                                return [r, g, b, 35];
                            }
                            // 如果是选中的房屋，显示高亮饱和颜色
                            if (selectedHousing && d.Lat === selectedHousing.Lat && d.Lng === selectedHousing.Lng) {
                                return [r, g, b, 240];
                            }
                            // 默认显示半透明真实颜色
                            return [r, g, b, 120];
                        },
                        getLineColor: d => {
                            // 对比模式边框
                            if (comparisonMode) {
                                const isPointA = comparisonA && d.Lat === comparisonA.Lat && d.Lng === comparisonA.Lng;
                                const isPointB = comparisonB && d.Lat === comparisonB.Lat && d.Lng === comparisonB.Lng;
                                
                                if (isPointA) {
                                    return [239, 68, 68, 255]; // 红色边框 - A
                                }
                                if (isPointB) {
                                    return [59, 130, 246, 255]; // 蓝色边框 - B
                                }
                                // 对比模式下，其他圆圈边框也淡化
                                return [255, 255, 255, 20];
                            }
                            if (selectedHousing && d.Lat === selectedHousing.Lat && d.Lng === selectedHousing.Lng) {
                                // 选中时使用金黄色边框，更醒目
                                return [255, 215, 0, 255];
                            }
                            return [255, 255, 255, 60];
                        },
                        getLineWidth: d => {
                            if (comparisonMode) {
                                if ((comparisonA && d.Lat === comparisonA.Lat && d.Lng === comparisonA.Lng) ||
                                    (comparisonB && d.Lat === comparisonB.Lat && d.Lng === comparisonB.Lng)) {
                                    return 100; // 对比模式更粗边框
                                }
                            }
                            if (selectedHousing && d.Lat === selectedHousing.Lat && d.Lng === selectedHousing.Lng) {
                                return 80; // 选中时更粗的边框
                            }
                            return 15;
                        },
                        stroked: true,
                        lineWidthMinPixels: 1,
                        lineWidthMaxPixels: 4,
                        radiusMinPixels: 4,
                        radiusMaxPixels: 40,
                        pickable: true,
                        opacity: 0.8,
                        autoHighlight: true,
                        highlightColor: d => {
                            // hover时显示真实颜色
                            const score = d.object ? d.object.score : 50;
                            const t = Math.min(1, Math.max(0, score / 95));
                            const colors = [
                                [94, 84, 142], [72, 118, 176], [59, 160, 168], [74, 189, 172], [129, 212, 175], [190, 237, 199]
                            ];
                            const idx = t * (colors.length - 1);
                            const i = Math.floor(idx);
                            const f = idx - i;
                            if (i >= colors.length - 1) return [...colors[colors.length - 1], 220];
                            return [
                                Math.round(colors[i][0] + (colors[i+1][0] - colors[i][0]) * f),
                                Math.round(colors[i][1] + (colors[i+1][1] - colors[i][1]) * f),
                                Math.round(colors[i][2] + (colors[i+1][2] - colors[i][2]) * f),
                                220
                            ];
                        },
                        onClick: (info) => {
                            if (info.object) {
                                if (comparisonMode) {
                                    // 对比模式：依次选择A和B
                                    if (!comparisonA) {
                                        setComparisonA(info.object);
                                    } else if (!comparisonB) {
                                        // 确保不选择同一个点
                                        if (info.object.Lat !== comparisonA.Lat || info.object.Lng !== comparisonA.Lng) {
                                            setComparisonB(info.object);
                                        }
                                    } else {
                                        // 两个都选了，重新开始
                                        setComparisonA(info.object);
                                        setComparisonB(null);
                                    }
                                } else {
                                    setSelectedHousing(info.object);
                                }
                            }
                        },
                        updateTriggers: {
                            getFillColor: [selectedHousing, selectedPersona, comparisonMode, comparisonA, comparisonB],
                            getLineColor: [selectedHousing, comparisonMode, comparisonA, comparisonB],
                            getLineWidth: [selectedHousing, comparisonMode, comparisonA, comparisonB]
                        },
                        transitions: { getRadius: 300, getFillColor: 300, getLineWidth: 200 }
                    })
                ];

                // POI Config - 非绿色配色方案
                const poiConfig = {
                    subway: { color: [56, 189, 248], hex: '#38bdf8', shape: 'square' },
                    mall:   { color: [244, 114, 182], hex: '#f472b6', shape: 'diamond' },
                    school: { color: [251, 146, 60], hex: '#fb923c', shape: 'triangle' },
                    park:   { color: [192, 132, 252],  hex: '#c084fc', shape: 'hexagon' },
                    public_service: { color: [248, 113, 113], hex: '#f87171', shape: 'star' }
                };
                
                // 创建SVG图标的函数
                const createIcon = (shape, color) => {
                    const size = 32;
                    const hexColor = color;
                    let path;
                    switch(shape) {
                        case 'square':
                            path = `<rect x="4" y="4" width="24" height="24" rx="3" fill="${hexColor}" stroke="white" stroke-width="2"/>`;
                            break;
                        case 'diamond':
                            path = `<polygon points="16,2 30,16 16,30 2,16" fill="${hexColor}" stroke="white" stroke-width="2"/>`;
                            break;
                        case 'triangle':
                            path = `<polygon points="16,3 29,28 3,28" fill="${hexColor}" stroke="white" stroke-width="2"/>`;
                            break;
                        case 'hexagon':
                            path = `<polygon points="16,2 28,9 28,23 16,30 4,23 4,9" fill="${hexColor}" stroke="white" stroke-width="2"/>`;
                            break;
                        case 'star':
                            path = `<polygon points="16,2 19,12 30,12 21,18 24,28 16,22 8,28 11,18 2,12 13,12" fill="${hexColor}" stroke="white" stroke-width="1.5"/>`;
                            break;
                        default:
                            path = `<circle cx="16" cy="16" r="12" fill="${hexColor}" stroke="white" stroke-width="2"/>`;
                    }
                    return `data:image/svg+xml;charset=utf-8,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">${path}</svg>`)}`;
                };

                Object.keys(poiVisible).forEach(key => {
                    if (poiVisible[key] && POI_DATA[key]) {
                        const config = poiConfig[key];
                        layerList.push(
                            new deck.IconLayer({
                                id: `poi-${key}`,
                                data: POI_DATA[key],
                                getPosition: d => [d.lng, d.lat],
                                getIcon: d => ({
                                    url: createIcon(config.shape, config.hex),
                                    width: 32,
                                    height: 32,
                                    anchorY: 16
                                }),
                                getSize: 28,
                                sizeScale: 1,
                                pickable: true,
                                onHover: (info) => { if(info.object) info.object.colorHex = config.hex; }
                            })
                        );
                    }
                });
                // 添加静态圆圈图层
                if (showStaticBuffer && selectedHousing) {
                    const circlePolygon = generateCirclePolygon(
                        [selectedHousing.Lng, selectedHousing.Lat],
                        bufferRadius
                    );
                    layerList.push(
                        new deck.PolygonLayer({
                            id: 'static-buffer',
                            data: [{ polygon: circlePolygon }],
                            getPolygon: d => d.polygon,
                            getFillColor: [66, 133, 244, 60],
                            getLineColor: [66, 133, 244, 200],
                            getLineWidth: 3,
                            lineWidthMinPixels: 2,
                            filled: true,
                            stroked: true,
                            pickable: false
                        })
                    );
                }
                
                // 添加动态等时圈图层
                if (showDynamicIsochrone && selectedHousing && isochroneData) {
                    layerList.push(
                        new deck.PolygonLayer({
                            id: 'dynamic-isochrone',
                            data: [{ polygon: isochroneData }],
                            getPolygon: d => d.polygon,
                            getFillColor: [52, 211, 153, 80],
                            getLineColor: [16, 185, 129, 255],
                            getLineWidth: 3,
                            lineWidthMinPixels: 2,
                            filled: true,
                            stroked: true,
                            pickable: false
                        })
                    );
                }
                
                return layerList;
            }, [filteredData, radius, elevationScale, poiVisible, selectedHousing, showStaticBuffer, showDynamicIsochrone, isochroneData, bufferRadius, selectedPersona, comparisonMode, comparisonA, comparisonB]);

            // POI Button
            const PoiToggle = ({ id, label }) => (
                <button 
                    className={`poi-btn ${id} ${poiVisible[id] ? 'active' : ''}`}
                    onClick={() => setPoiVisible(prev => ({...prev, [id]: !prev[id]}))}
                >
                    {poiVisible[id] && <div className={`shape ${id}`}></div>}
                    {label}
                </button>
            );

            return (
                <div style={{position: 'relative', width: '100%', height: '100vh'}}>
                    <DeckGLMap layers={layers} viewState={viewState} onViewStateChange={({viewState}) => setViewState(viewState)} />

                    {view === 'landing' && <LandingPage onStart={() => setView('dashboard')} loading={loading} count={data.length} error={error} />}

                    {view === 'dashboard' && (
                        <>
                            <div className="header-bar fade-in-up">
                                <h1 
                                    className="text-2xl font-bold text-white drop-shadow-sm" 
                                    style={{margin:0, padding:'24px', letterSpacing:'-0.02em', cursor:'pointer'}}
                                    onClick={() => setView('landing')}
                                    title="Back to Home"
                                >
                                    Tianhe <span style={{color:'#a78bfa'}}>Analytics</span>
                                </h1>
                            </div>

                            <div className="glass-panel control-panel fade-in-up" style={{position:'absolute', top: '90px', left: '24px', width: '320px', padding: '24px', zIndex: 10}}>
                                <div className="space-y-7">
                                    <div>
                                        <div className="label-sm mb-3">Amenities Layers</div>
                                        <div style={{display:'flex', flexWrap:'wrap', gap:'6px'}}>
                                            <PoiToggle id="subway" label="Metro" />
                                            <PoiToggle id="mall" label="Mall" />
                                            <PoiToggle id="school" label="School" />
                                            <PoiToggle id="park" label="Park" />
                                            <PoiToggle id="public_service" label="Public" />
                                        </div>
                                    </div>
                                    <hr style={{borderColor:'rgba(255,255,255,0.08)'}}/>
                                    
                                    {/* Persona Filter */}
                                    <div>
                                        <div className="label-sm mb-3">User Persona</div>
                                        <select 
                                            value={selectedPersona}
                                            onChange={(e) => setSelectedPersona(e.target.value)}
                                            style={{
                                                width: '100%',
                                                padding: '10px 12px',
                                                background: 'rgba(255,255,255,0.08)',
                                                border: '1px solid rgba(255,255,255,0.15)',
                                                borderRadius: '8px',
                                                color: '#e2e8f0',
                                                fontSize: '13px',
                                                cursor: 'pointer',
                                                outline: 'none'
                                            }}
                                        >
                                            {Object.entries(PERSONAS).map(([key, persona]) => (
                                                <option key={key} value={key} style={{background: '#1e293b', color: '#e2e8f0'}}>
                                                    {persona.icon} {persona.name}
                                                </option>
                                            ))}
                                        </select>
                                        <div style={{marginTop: '8px', padding: '10px', background: 'rgba(255,255,255,0.03)', borderRadius: '6px', border: `1px solid ${PERSONAS[selectedPersona].color}30`}}>
                                            <div style={{fontSize: '11px', color: PERSONAS[selectedPersona].color, fontWeight: '500', marginBottom: '4px'}}>
                                                {PERSONAS[selectedPersona].icon} {PERSONAS[selectedPersona].name}
                                            </div>
                                            <div style={{fontSize: '10px', color: '#64748b', lineHeight: '1.4'}}>
                                                {PERSONAS[selectedPersona].description}
                                            </div>
                                        </div>
                                    </div>
                                    <hr style={{borderColor:'rgba(255,255,255,0.08)'}}/>
                                    
                                    {/* Isochrone Controls */}
                                    <div>
                                        <div className="label-sm mb-3">Accessibility Analysis</div>
                                        <div style={{display:'flex', flexDirection:'column', gap:'8px'}}>
                                            <button 
                                                className={`poi-btn ${showStaticBuffer ? 'active' : ''}`}
                                                onClick={() => setShowStaticBuffer(!showStaticBuffer)}
                                                disabled={!selectedHousing}
                                                style={{opacity: selectedHousing ? 1 : 0.5, justifyContent:'flex-start'}}
                                            >
                                                <div style={{width:'10px', height:'10px', borderRadius:'50%', border:'2px solid #4285f4', background: showStaticBuffer ? '#4285f4' : 'transparent'}}></div>
                                                Static Buffer (1km)
                                            </button>
                                            <button 
                                                className={`poi-btn ${showDynamicIsochrone ? 'active' : ''}`}
                                                onClick={() => setShowDynamicIsochrone(!showDynamicIsochrone)}
                                                disabled={!selectedHousing}
                                                style={{opacity: selectedHousing ? 1 : 0.5, justifyContent:'flex-start'}}
                                            >
                                                <div style={{width:'10px', height:'10px', background: showDynamicIsochrone ? '#10b981' : 'transparent', border:'2px solid #10b981', borderRadius:'2px'}}></div>
                                                Dynamic Isochrone (15min)
                                                {isochroneLoading && <span style={{marginLeft:'8px', fontSize:'10px'}}>Loading...</span>}
                                            </button>
                                        </div>
                                        {!selectedHousing && (
                                            <div style={{fontSize:'11px', color:'#64748b', marginTop:'8px', fontStyle:'italic'}}>
                                                Click a housing block to enable
                                            </div>
                                        )}
                                    </div>
                                    <hr style={{borderColor:'rgba(255,255,255,0.08)'}}/>
                                    <div>
                                        <div className="flex justify-between mb-2 label-sm">
                                            <span>Price Filter: </span>
                                            <span className="text-yellow-400 value-mono">{(filterPrice[0]/10000).toFixed(0)}-{(filterPrice[1]/10000).toFixed(0)}w</span>
                                        </div>
                                        {/* Price Distribution Histogram */}
                                        {(() => {
                                            const bins = 20;
                                            const minPrice = 10000, maxPrice = 200000;
                                            const binWidth = (maxPrice - minPrice) / bins;
                                            const histogram = Array(bins).fill(0);
                                            data.forEach(d => {
                                                const binIndex = Math.min(bins - 1, Math.floor((d.unit_price - minPrice) / binWidth));
                                                if (binIndex >= 0) histogram[binIndex]++;
                                            });
                                            const maxCount = Math.max(...histogram);
                                            return (
                                                <div style={{display:'flex', alignItems:'flex-end', height:'24px', gap:'1px', marginBottom:'4px'}}>
                                                    {histogram.map((count, i) => {
                                                        const binStart = minPrice + i * binWidth;
                                                        const binEnd = binStart + binWidth;
                                                        const isInRange = binStart < filterPrice[1] && binEnd > filterPrice[0];
                                                        return (
                                                            <div key={i} style={{
                                                                flex: 1,
                                                                height: `${maxCount > 0 ? (count / maxCount) * 100 : 0}%`,
                                                                minHeight: count > 0 ? '2px' : '0',
                                                                background: isInRange ? 'rgba(250, 204, 21, 0.6)' : 'rgba(255,255,255,0.15)',
                                                                borderRadius: '1px 1px 0 0',
                                                                transition: 'background 0.2s'
                                                            }}/>
                                                        );
                                                    })}
                                                </div>
                                            );
                                        })()}
                                        <div className="range-slider">
                                            <div className="range-slider-track"></div>
                                            <div className="range-slider-range" style={{
                                                left: `${((filterPrice[0] - 10000) / (200000 - 10000)) * 100}%`,
                                                width: `${((filterPrice[1] - filterPrice[0]) / (200000 - 10000)) * 100}%`
                                            }}></div>
                                            <input type="range" min="10000" max="200000" step="5000" value={filterPrice[0]} 
                                                onChange={e=>setFilterPrice([Math.min(Number(e.target.value), filterPrice[1] - 5000), filterPrice[1]])}/>
                                            <input type="range" min="10000" max="200000" step="5000" value={filterPrice[1]} 
                                                onChange={e=>setFilterPrice([filterPrice[0], Math.max(Number(e.target.value), filterPrice[0] + 5000)])}/>
                                        </div>
                                    </div>
                                    <div style={{marginTop: '16px'}}>
                                        <div className="flex justify-between mb-2 label-sm">
                                            <span>Access Score: </span>
                                            <span className="text-blue-400 value-mono">{filterAccess[0]}-{filterAccess[1]}</span>
                                        </div>
                                        {/* Access Score Distribution Histogram */}
                                        {(() => {
                                            const bins = 20;
                                            const minScore = 0, maxScore = 100;
                                            const binWidth = (maxScore - minScore) / bins;
                                            const histogram = Array(bins).fill(0);
                                            data.forEach(d => {
                                                const binIndex = Math.min(bins - 1, Math.floor((d.score - minScore) / binWidth));
                                                if (binIndex >= 0) histogram[binIndex]++;
                                            });
                                            const maxCount = Math.max(...histogram);
                                            return (
                                                <div style={{display:'flex', alignItems:'flex-end', height:'24px', gap:'1px', marginBottom:'4px'}}>
                                                    {histogram.map((count, i) => {
                                                        const binStart = minScore + i * binWidth;
                                                        const binEnd = binStart + binWidth;
                                                        const isInRange = binStart < filterAccess[1] && binEnd > filterAccess[0];
                                                        return (
                                                            <div key={i} style={{
                                                                flex: 1,
                                                                height: `${maxCount > 0 ? (count / maxCount) * 100 : 0}%`,
                                                                minHeight: count > 0 ? '2px' : '0',
                                                                background: isInRange ? 'rgba(96, 165, 250, 0.6)' : 'rgba(255,255,255,0.15)',
                                                                borderRadius: '1px 1px 0 0',
                                                                transition: 'background 0.2s'
                                                            }}/>
                                                        );
                                                    })}
                                                </div>
                                            );
                                        })()}
                                        <div className="range-slider">
                                            <div className="range-slider-track"></div>
                                            <div className="range-slider-range" style={{
                                                left: `${(filterAccess[0] / 100) * 100}%`,
                                                width: `${((filterAccess[1] - filterAccess[0]) / 100) * 100}%`
                                            }}></div>
                                            <input type="range" min="0" max="100" value={filterAccess[0]} 
                                                onChange={e=>setFilterAccess([Math.min(Number(e.target.value), filterAccess[1] - 1), filterAccess[1]])}/>
                                            <input type="range" min="0" max="100" value={filterAccess[1]} 
                                                onChange={e=>setFilterAccess([filterAccess[0], Math.max(Number(e.target.value), filterAccess[0] + 1)])}/>
                                        </div>
                                    </div>
                                    {/* Reset Button */}
                                    <button
                                        onClick={() => {
                                            setFilterPrice([10000, 200000]);
                                            setFilterAccess([0, 100]);
                                            setSelectedPersona('standard');
                                            setPoiVisible({subway: false, mall: false, school: false, park: false, public_service: false});
                                            setComparisonMode(false);
                                            setComparisonA(null);
                                            setComparisonB(null);
                                            setShowStaticBuffer(false);
                                            setShowDynamicIsochrone(false);
                                        }}
                                        style={{
                                            width: '100%',
                                            marginTop: '16px',
                                            padding: '10px',
                                            background: 'rgba(255,255,255,0.05)',
                                            border: '1px solid rgba(255,255,255,0.1)',
                                            borderRadius: '8px',
                                            color: '#94a3b8',
                                            fontSize: '12px',
                                            fontWeight: '500',
                                            cursor: 'pointer',
                                            transition: 'all 0.2s',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            gap: '6px'
                                        }}
                                        onMouseOver={e => {e.target.style.background = 'rgba(255,255,255,0.1)'; e.target.style.color = '#e2e8f0';}}
                                        onMouseOut={e => {e.target.style.background = 'rgba(255,255,255,0.05)'; e.target.style.color = '#94a3b8';}}
                                    >
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                                            <path d="M3 3v5h5"/>
                                        </svg>
                                        Reset All Filters
                                    </button>
                                </div>
                            </div>

                            {/* Housing Detail Cards - Comparison Mode */}
                            {(selectedHousing || comparisonA) && (
                                <div style={{position:'absolute', top:'90px', right:'24px', zIndex:10, display:'flex', gap:'12px', flexDirection: comparisonMode && comparisonA && comparisonB ? 'row' : 'column'}}>
                                    
                                    {/* Card A - Primary Selection or Comparison A */}
                                    {(comparisonMode ? comparisonA : selectedHousing) && (
                                        <div className="glass-panel fade-in-up" style={{padding:'0', width: comparisonMode && comparisonA && comparisonB ? '280px' : '320px', overflow:'hidden', position:'relative'}}>
                                            {/* Point Label for Comparison */}
                                            {comparisonMode && comparisonA && (
                                                <div style={{position:'absolute', top:'12px', left:'12px', background:'#ef4444', color:'white', padding:'4px 10px', borderRadius:'4px', fontSize:'11px', fontWeight:'600', zIndex:2}}>
                                                    Point A
                                                </div>
                                            )}
                                            {/* Close Button */}
                                            <button 
                                                onClick={() => {
                                                    if (comparisonMode) {
                                                        setComparisonMode(false);
                                                        setComparisonA(null);
                                                        setComparisonB(null);
                                                    }
                                                    setSelectedHousing(null);
                                                }}
                                                style={{position:'absolute', top:'12px', right:'12px', background:'rgba(0,0,0,0.5)', border:'none', borderRadius:'50%', width:'28px', height:'28px', cursor:'pointer', display:'flex', alignItems:'center', justifyContent:'center', zIndex:2}}
                                            >
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                                                    <path d="M18 6L6 18M6 6l12 12"/>
                                                </svg>
                                            </button>
                                            
                                            {/* Housing Image */}
                                            <div style={{width:'100%', height: comparisonMode && comparisonB ? '100px' : '140px', background:'#f8fafc', display:'flex', alignItems:'center', justifyContent:'center', position:'relative', overflow:'hidden'}}>
                                                <img 
                                                    src={`house${((Math.floor((comparisonMode ? comparisonA : selectedHousing).Lat * 10000) + Math.floor((comparisonMode ? comparisonA : selectedHousing).Lng * 10000)) % 4) + 1}.png`}
                                                    alt="Housing"
                                                    style={{width:'100%', height:'100%', objectFit:'contain', background:'#fff'}}
                                                />
                                                {/* Price Badge */}
                                                <div style={{position:'absolute', bottom:'8px', left:'8px', background:'rgba(250, 204, 21, 0.95)', color:'#000', padding:'4px 10px', borderRadius:'4px', fontSize:'13px', fontWeight:'600'}}>
                                                    ¥{Math.round((comparisonMode ? comparisonA : selectedHousing).unit_price).toLocaleString()}/㎡
                                                </div>
                                            </div>
                                            
                                            {/* Content */}
                                            <div style={{padding:'12px'}}>
                                                <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'8px', marginBottom:'10px'}}>
                                                    <div style={{background:'rgba(255,255,255,0.05)', padding:'8px', borderRadius:'6px'}}>
                                                        <div style={{fontSize:'9px', color:'#64748b', marginBottom:'2px'}}>PRICE</div>
                                                        <div style={{fontSize:'13px', color:'#facc15', fontFamily:'Roboto Mono'}}>
                                                            ¥{Math.round((comparisonMode ? comparisonA : selectedHousing).unit_price).toLocaleString()}
                                                        </div>
                                                    </div>
                                                    <div style={{background:'rgba(255,255,255,0.05)', padding:'8px', borderRadius:'6px'}}>
                                                        <div style={{fontSize:'9px', color:'#64748b', marginBottom:'2px'}}>ACCESS</div>
                                                        <div style={{fontSize:'13px', color:'#60a5fa', fontFamily:'Roboto Mono'}}>
                                                            {(comparisonMode ? comparisonA : selectedHousing).score.toFixed(1)}
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                {/* Compare Button - Only show when not in comparison mode */}
                                                {!comparisonMode && (
                                                    <button
                                                        onClick={() => {
                                                            setComparisonMode(true);
                                                            setComparisonA(selectedHousing);
                                                            setComparisonB(null);
                                                        }}
                                                        style={{
                                                            width: '100%',
                                                            padding: '10px',
                                                            background: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
                                                            border: 'none',
                                                            borderRadius: '8px',
                                                            color: 'white',
                                                            fontSize: '12px',
                                                            fontWeight: '600',
                                                            cursor: 'pointer',
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            justifyContent: 'center',
                                                            gap: '6px',
                                                            transition: 'all 0.2s'
                                                        }}
                                                    >
                                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                            <path d="M16 3h5v5M8 3H3v5M3 16v5h5M21 16v5h-5M21 3l-7 7M3 21l7-7"/>
                                                        </svg>
                                                        Compare with Another
                                                    </button>
                                                )}
                                                
                                                {/* Waiting for Point B */}
                                                {comparisonMode && !comparisonB && (
                                                    <div style={{textAlign:'center', padding:'8px', background:'rgba(245,158,11,0.1)', borderRadius:'6px', border:'1px dashed #f59e0b'}}>
                                                        <div style={{fontSize:'11px', color:'#f59e0b'}}>👆 Click another housing to compare</div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )}
                                    
                                    {/* Card B - Comparison B */}
                                    {comparisonMode && comparisonB && (
                                        <div className="glass-panel fade-in-up" style={{padding:'0', width:'280px', overflow:'hidden', position:'relative'}}>
                                            {/* Point Label */}
                                            <div style={{position:'absolute', top:'12px', left:'12px', background:'#3b82f6', color:'white', padding:'4px 10px', borderRadius:'4px', fontSize:'11px', fontWeight:'600', zIndex:2}}>
                                                Point B
                                            </div>
                                            {/* Close Button */}
                                            <button 
                                                onClick={() => setComparisonB(null)}
                                                style={{position:'absolute', top:'12px', right:'12px', background:'rgba(0,0,0,0.5)', border:'none', borderRadius:'50%', width:'28px', height:'28px', cursor:'pointer', display:'flex', alignItems:'center', justifyContent:'center', zIndex:2}}
                                            >
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                                                    <path d="M18 6L6 18M6 6l12 12"/>
                                                </svg>
                                            </button>
                                            
                                            {/* Housing Image */}
                                            <div style={{width:'100%', height:'100px', background:'#f8fafc', display:'flex', alignItems:'center', justifyContent:'center', position:'relative', overflow:'hidden'}}>
                                                <img 
                                                    src={`house${((Math.floor(comparisonB.Lat * 10000) + Math.floor(comparisonB.Lng * 10000)) % 4) + 1}.png`}
                                                    alt="Housing"
                                                    style={{width:'100%', height:'100%', objectFit:'contain', background:'#fff'}}
                                                />
                                                {/* Price Badge */}
                                                <div style={{position:'absolute', bottom:'8px', left:'8px', background:'rgba(250, 204, 21, 0.95)', color:'#000', padding:'4px 10px', borderRadius:'4px', fontSize:'13px', fontWeight:'600'}}>
                                                    ¥{Math.round(comparisonB.unit_price).toLocaleString()}/㎡
                                                </div>
                                            </div>
                                            
                                            {/* Content */}
                                            <div style={{padding:'12px'}}>
                                                <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'8px'}}>
                                                    <div style={{background:'rgba(255,255,255,0.05)', padding:'8px', borderRadius:'6px'}}>
                                                        <div style={{fontSize:'9px', color:'#64748b', marginBottom:'2px'}}>PRICE</div>
                                                        <div style={{fontSize:'13px', color:'#facc15', fontFamily:'Roboto Mono'}}>
                                                            ¥{Math.round(comparisonB.unit_price).toLocaleString()}
                                                        </div>
                                                    </div>
                                                    <div style={{background:'rgba(255,255,255,0.05)', padding:'8px', borderRadius:'6px'}}>
                                                        <div style={{fontSize:'9px', color:'#64748b', marginBottom:'2px'}}>ACCESS</div>
                                                        <div style={{fontSize:'13px', color:'#60a5fa', fontFamily:'Roboto Mono'}}>
                                                            {comparisonB.score.toFixed(1)}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    
                                    {/* Comparison Analysis Card */}
                                    {comparisonMode && comparisonA && comparisonB && (
                                        <div className="glass-panel fade-in-up" style={{padding:'14px', width:'280px'}}>
                                            <div style={{fontSize:'12px', color:'#f59e0b', fontWeight:'600', marginBottom:'12px', display:'flex', alignItems:'center', gap:'6px'}}>
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                    <path d="M3 3v18h18"/>
                                                    <path d="M18 17V9M13 17V5M8 17v-3"/>
                                                </svg>
                                                Comparison Analysis
                                            </div>
                                            
                                            {/* Price Comparison */}
                                            <div style={{marginBottom:'10px'}}>
                                                <div style={{display:'flex', justifyContent:'space-between', fontSize:'10px', color:'#64748b', marginBottom:'4px'}}>
                                                    <span>Price Difference</span>
                                                    <span style={{color:'#facc15', fontWeight:'600'}}>
                                                        {comparisonA.unit_price > comparisonB.unit_price ? 'A' : 'B'} is {((Math.abs(comparisonA.unit_price - comparisonB.unit_price) / Math.min(comparisonA.unit_price, comparisonB.unit_price)) * 100).toFixed(0)}% higher
                                                    </span>
                                                </div>
                                                <div style={{height:'6px', background:'#1e293b', borderRadius:'3px', overflow:'hidden', display:'flex'}}>
                                                    <div style={{width:`${(comparisonA.unit_price / (comparisonA.unit_price + comparisonB.unit_price)) * 100}%`, background:'#ef4444', transition:'width 0.3s'}}></div>
                                                    <div style={{flex:1, background:'#3b82f6'}}></div>
                                                </div>
                                            </div>
                                            
                                            {/* Access Comparison */}
                                            <div style={{marginBottom:'10px'}}>
                                                <div style={{display:'flex', justifyContent:'space-between', fontSize:'10px', color:'#64748b', marginBottom:'4px'}}>
                                                    <span>Accessibility</span>
                                                    <span style={{color:'#60a5fa', fontWeight:'600'}}>
                                                        {comparisonA.score > comparisonB.score ? 'A' : 'B'} is better
                                                    </span>
                                                </div>
                                                <div style={{height:'6px', background:'#1e293b', borderRadius:'3px', overflow:'hidden', display:'flex'}}>
                                                    <div style={{width:`${(comparisonA.score / (comparisonA.score + comparisonB.score)) * 100}%`, background:'#ef4444', transition:'width 0.3s'}}></div>
                                                    <div style={{flex:1, background:'#3b82f6'}}></div>
                                                </div>
                                            </div>
                                            
                                            {/* Value Score */}
                                            <div style={{display:'flex', gap:'8px', marginBottom:'10px'}}>
                                                <div style={{flex:1, textAlign:'center', padding:'8px', background:'rgba(239,68,68,0.1)', borderRadius:'6px', border:'1px solid rgba(239,68,68,0.2)'}}>
                                                    <div style={{fontSize:'9px', color:'#64748b', marginBottom:'2px'}}>Value (¥/Score)</div>
                                                    <div style={{fontSize:'12px', color:'#ef4444', fontWeight:'600'}}>¥{Math.round(comparisonA.unit_price / comparisonA.score).toLocaleString()}</div>
                                                </div>
                                                <div style={{flex:1, textAlign:'center', padding:'8px', background:'rgba(59,130,246,0.1)', borderRadius:'6px', border:'1px solid rgba(59,130,246,0.2)'}}>
                                                    <div style={{fontSize:'9px', color:'#64748b', marginBottom:'2px'}}>Value (¥/Score)</div>
                                                    <div style={{fontSize:'12px', color:'#3b82f6', fontWeight:'600'}}>¥{Math.round(comparisonB.unit_price / comparisonB.score).toLocaleString()}</div>
                                                </div>
                                            </div>
                                            
                                            {/* Insight */}
                                            <div style={{fontSize:'10px', color:'#94a3b8', lineHeight:'1.5', padding:'10px', background:'rgba(245,158,11,0.1)', borderRadius:'6px', borderLeft:'3px solid #f59e0b'}}>
                                                {(() => {
                                                    const valueA = comparisonA.unit_price / comparisonA.score;
                                                    const valueB = comparisonB.unit_price / comparisonB.score;
                                                    const betterValue = valueA < valueB ? 'A' : 'B';
                                                    const priceDiff = Math.abs(comparisonA.unit_price - comparisonB.unit_price);
                                                    const scoreDiff = Math.abs(comparisonA.score - comparisonB.score);
                                                    
                                                    if (scoreDiff < 5 && priceDiff > 20000) {
                                                        return `💡 Similar accessibility but ¥${Math.round(priceDiff).toLocaleString()} price gap - spatial inequality at work.`;
                                                    } else if (betterValue === 'A' && comparisonA.unit_price < comparisonB.unit_price) {
                                                        return `💡 Point A offers better value - lower price with comparable accessibility.`;
                                                    } else if (betterValue === 'B' && comparisonB.unit_price < comparisonA.unit_price) {
                                                        return `💡 Point B offers better value - lower price with comparable accessibility.`;
                                                    } else {
                                                        return `💡 Point ${betterValue} has better value ratio (¥/accessibility point).`;
                                                    }
                                                })()}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            <div className="glass-panel legend-panel fade-in-up" style={{position:'absolute', bottom:'24px', right:'24px', padding:'20px', zIndex:10, width:'260px'}}>
                                <div className="label-sm mb-3">Analysis Legend</div>
                                
                                <div style={{marginBottom:'16px'}}>
                                    <div style={{fontSize:'10px', color:'#94a3b8', marginBottom:'8px', fontWeight:'500'}}>Bubble Size = Price</div>
                                    <div style={{display:'flex', alignItems:'center', gap:'8px', marginTop:'8px'}}>
                                        <div style={{width:'10px', height:'10px', background:'#64748b', opacity:0.7, borderRadius:'50%', border:'1px solid rgba(255,255,255,0.3)'}}></div>
                                        <div style={{width:'18px', height:'18px', background:'#64748b', opacity:0.7, borderRadius:'50%', border:'1px solid rgba(255,255,255,0.3)'}}></div>
                                        <div style={{width:'28px', height:'28px', background:'#64748b', opacity:0.7, borderRadius:'50%', border:'1px solid rgba(255,255,255,0.3)'}}></div>
                                        <span style={{fontSize:'10px', color:'#64748b', marginLeft:'6px'}}>Low → High</span>
                                    </div>
                                </div>
                                <div style={{marginBottom:'16px'}}>
                                    <div style={{fontSize:'10px', color:'#94a3b8', marginBottom:'6px', fontWeight:'500'}}>Color = Accessibility</div>
                                    <div style={{height:'8px', borderRadius:'4px', background:'linear-gradient(to right, #5e548e, #4876b0, #3ba0a8, #4abdac, #81d4af, #beedc7)'}}></div>
                                    <div style={{display:'flex', justifyContent:'space-between', fontSize:'10px', color:'#64748b', marginTop:'4px', fontWeight:'500'}}><span>Low</span><span>High</span></div>
                                </div>
                                {(showStaticBuffer || showDynamicIsochrone) && (
                                    <div>
                                        <div style={{fontSize:'10px', color:'#94a3b8', marginBottom:'8px', fontWeight:'500'}}>Accessibility Range</div>
                                        {showStaticBuffer && (
                                            <div style={{display:'flex', alignItems:'center', gap:'8px', marginBottom:'6px'}}>
                                                <div style={{width:'20px', height:'12px', background:'rgba(66, 133, 244, 0.3)', border:'2px solid #4285f4', borderRadius:'2px'}}></div>
                                                <span style={{fontSize:'10px', color:'#64748b'}}>Static Buffer (1km)</span>
                                            </div>
                                        )}
                                        {showDynamicIsochrone && (
                                            <div style={{display:'flex', alignItems:'center', gap:'8px'}}>
                                                <div style={{width:'20px', height:'12px', background:'rgba(16, 185, 129, 0.3)', border:'2px solid #10b981', borderRadius:'2px'}}></div>
                                                <span style={{fontSize:'10px', color:'#64748b'}}>15-min Walk (Real)</span>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>

                            {/* === AI CHATBOT UI === */}
                            {view === 'dashboard' && (
                                <>
                                    {/* Chat Toggle Button */}
                                    <button
                                        className={`ai-chat-toggle ${chatOpen ? 'expanded' : ''}`}
                                        onClick={() => setChatOpen(!chatOpen)}
                                        aria-label="Toggle AI Assistant"
                                    >
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                                            {chatOpen ? (
                                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                                            ) : (
                                                <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
                                            )}
                                        </svg>
                                    </button>

                                    {/* Chat Panel */}
                                    <div className={`ai-chat-panel ${chatOpen ? 'open' : ''}`}>
                                        {/* Header */}
                                        <div className="ai-chat-header">
                                            <div className="ai-avatar">
                                                <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
                                                </svg>
                                            </div>
                                            <div className="ai-chat-title">
                                                <h3>天河助手 Tianhe Assistant</h3>
                                                <p>AI-powered housing advisor</p>
                                            </div>
                                        </div>

                                        {/* Messages */}
                                        <div className="ai-chat-messages">
                                            {messages.map((msg, idx) => (
                                                <div key={idx} className={`chat-message ${msg.role === 'assistant' ? 'ai' : msg.role}`}>
                                                    <div className="chat-message-avatar">
                                                        {msg.role === 'ai' || msg.role === 'assistant' ? '🤖' : '👤'}
                                                    </div>
                                                    <div>
                                                        <div className="chat-message-content">
                                                            {msg.content}
                                                        </div>
                                                        {msg.actions && msg.actions.length > 0 && (
                                                            <div className="chat-message-action">
                                                                已执行: {msg.actions.map(a => {
                                                                    const names = {
                                                                        'updateMapFilter': '筛选房源',
                                                                        'setPersona': '切换模式',
                                                                        'togglePOI': '更新标记',
                                                                        'flyToArea': '定位区域',
                                                                        'compareAreas': '对比模式'
                                                                    };
                                                                    return names[a] || a;
                                                                }).join(', ')}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            ))}
                                            {isTyping && (
                                                <div className="chat-message ai">
                                                    <div className="chat-message-avatar">🤖</div>
                                                    <div className="typing-indicator">
                                                        <div className="typing-dot"></div>
                                                        <div className="typing-dot"></div>
                                                        <div className="typing-dot"></div>
                                                    </div>
                                                </div>
                                            )}
                                            <div ref={messagesEndRef} />
                                        </div>

                                        {/* Quick Prompts - 只在开始时显示 */}
                                        {messages.length <= 1 && (
                                            <div className="quick-prompts">
                                                {quickPrompts.map((prompt, idx) => (
                                                    <button
                                                        key={idx}
                                                        className="quick-prompt"
                                                        onClick={() => handleSendMessage(prompt)}
                                                        disabled={isTyping}
                                                    >
                                                        {prompt}
                                                    </button>
                                                ))}
                                            </div>
                                        )}

                                        {/* Input Area */}
                                        <div className="ai-chat-input-area">
                                            <input
                                                type="text"
                                                className="ai-chat-input"
                                                placeholder="描述你的需求..."
                                                value={inputValue}
                                                onChange={(e) => setInputValue(e.target.value)}
                                                onKeyPress={(e) => {
                                                    if (e.key === 'Enter' && !e.shiftKey) {
                                                        e.preventDefault();
                                                        handleSendMessage(inputValue);
                                                    }
                                                }}
                                                disabled={isTyping}
                                            />
                                            <button
                                                className="ai-chat-send"
                                                onClick={() => handleSendMessage(inputValue)}
                                                disabled={isTyping || !inputValue.trim()}
                                            >
                                                <svg width="18" height="18" viewBox="0 0 24 24" fill="white">
                                                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </>
                            )}
                        </>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>