<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Test GitHub Pages AI</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; }
        .test-section { margin: 30px 0; padding: 20px; border: 2px solid #ddd; border-radius: 8px; }
        .test-section h3 { margin-top: 0; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #667eea; color: white; border: none; border-radius: 6px; font-size: 14px; }
        button:hover { background: #5568d3; }
        .result { margin-top: 15px; padding: 15px; background: #f5f5f5; border-radius: 6px; white-space: pre-wrap; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto; }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .loading { color: #f59e0b; }
    </style>
</head>
<body>
    <h1>ğŸ§ª GitHub Pages AI åŠŸèƒ½æµ‹è¯•</h1>
    <p>è¿™ä¸ªé¡µé¢æµ‹è¯• AI åŠŸèƒ½æ˜¯å¦èƒ½åœ¨ GitHub Pages ä¸Šæ­£å¸¸å·¥ä½œï¼ˆå‰ç«¯ç›´è°ƒ APIï¼‰</p>

    <div class="test-section">
        <h3>æµ‹è¯• 1: API è¿æ¥æµ‹è¯•</h3>
        <button onclick="testAPIConnection()">æµ‹è¯• API è¿æ¥</button>
        <div id="test1-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>æµ‹è¯• 2: AI å¯¹è¯æµ‹è¯•ï¼ˆä¸­æ–‡ï¼‰</h3>
        <button onclick="testChineseChat()">æµ‹è¯•ï¼š"æˆ‘åˆšæ¯•ä¸šï¼Œé¢„ç®—3000ï¼Œè¦ç¦»åœ°é“è¿‘"</button>
        <div id="test2-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>æµ‹è¯• 3: AI å¯¹è¯æµ‹è¯•ï¼ˆè‹±æ–‡ï¼‰</h3>
        <button onclick="testEnglishChat()">æµ‹è¯•ï¼š"Show me affordable housing"</button>
        <div id="test3-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>æµ‹è¯• 4: JSON æŒ‡ä»¤è§£æ</h3>
        <button onclick="testJSONParsing()">æµ‹è¯• JSON è§£æ</button>
        <div id="test4-result" class="result"></div>
    </div>

    <script>
        const AI_CONFIG = {
            apiKey: 'sk-k4TRuzAh3xPJREVysLh25UggIbiptLi8PaDPP6ij6CGZid7j',
            apiBase: 'https://api.tu-zi.com/v1',
            model: 'gpt-5'
        };

        const SYSTEM_PROMPT = `You are "å¤©æ²³åŠ©æ‰‹", an expert urban planning assistant.

**RESPONSE FORMAT**: Always return pure JSON:
{
  "commands": [
    { "action": "updateMapFilter", "priceMin": 10000, "priceMax": 35000 }
  ],
  "message": "Your response"
}

**RULES**:
- "3000" = 30,000 CNY/sqm
- Return pure JSON, no markdown
- Keep message concise`;

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'loading';
            element.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            element.scrollTop = element.scrollHeight;
        }

        function clear(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        async function testAPIConnection() {
            const resultId = 'test1-result';
            clear(resultId);
            log(resultId, 'å¼€å§‹æµ‹è¯• API è¿æ¥...', 'loading');

            try {
                const response = await fetch(`${AI_CONFIG.apiBase}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AI_CONFIG.apiKey}`
                    },
                    body: JSON.stringify({
                        model: AI_CONFIG.model,
                        messages: [{ role: 'user', content: 'Say "API working"' }],
                        max_tokens: 50
                    })
                });

                log(resultId, `å“åº”çŠ¶æ€: ${response.status}`, response.ok ? 'success' : 'error');

                if (response.ok) {
                    const data = await response.json();
                    log(resultId, `âœ… API è¿æ¥æˆåŠŸï¼`, 'success');
                    log(resultId, `æ¨¡å‹: ${data.model}`);
                    log(resultId, `å›å¤: ${data.choices[0].message.content}`);
                } else {
                    const errorText = await response.text();
                    log(resultId, `âŒ API é”™è¯¯: ${errorText}`, 'error');
                }
            } catch (error) {
                log(resultId, `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testChineseChat() {
            const resultId = 'test2-result';
            clear(resultId);
            log(resultId, 'æµ‹è¯•ä¸­æ–‡å¯¹è¯...', 'loading');

            try {
                const response = await fetch(`${AI_CONFIG.apiBase}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AI_CONFIG.apiKey}`
                    },
                    body: JSON.stringify({
                        model: AI_CONFIG.model,
                        messages: [
                            { role: 'system', content: SYSTEM_PROMPT },
                            { role: 'user', content: 'æˆ‘åˆšæ¯•ä¸šï¼Œé¢„ç®—3000ï¼Œè¦ç¦»åœ°é“è¿‘' }
                        ],
                        temperature: 0.7,
                        max_tokens: 800
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const content = data.choices[0].message.content;

                    log(resultId, 'âœ… AI å›å¤æˆåŠŸï¼', 'success');
                    log(resultId, '\nåŸå§‹å›å¤:');
                    log(resultId, content);

                    // Try to parse JSON
                    try {
                        const cleaned = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                        const parsed = JSON.parse(cleaned);
                        log(resultId, '\nâœ… JSON è§£ææˆåŠŸï¼', 'success');
                        log(resultId, `æŒ‡ä»¤æ•°é‡: ${parsed.commands?.length || 0}`);
                        log(resultId, `æ¶ˆæ¯: ${parsed.message}`);
                    } catch (e) {
                        log(resultId, '\nâš ï¸  JSON è§£æå¤±è´¥ï¼ˆAI å¯èƒ½è¿”å›äº†çº¯æ–‡æœ¬ï¼‰', 'error');
                    }
                } else {
                    log(resultId, `âŒ API é”™è¯¯: ${response.status}`, 'error');
                }
            } catch (error) {
                log(resultId, `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testEnglishChat() {
            const resultId = 'test3-result';
            clear(resultId);
            log(resultId, 'æµ‹è¯•è‹±æ–‡å¯¹è¯...', 'loading');

            try {
                const response = await fetch(`${AI_CONFIG.apiBase}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AI_CONFIG.apiKey}`
                    },
                    body: JSON.stringify({
                        model: AI_CONFIG.model,
                        messages: [
                            { role: 'system', content: SYSTEM_PROMPT },
                            { role: 'user', content: 'Show me affordable housing near metro' }
                        ],
                        temperature: 0.7,
                        max_tokens: 800
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const content = data.choices[0].message.content;

                    log(resultId, 'âœ… AI å›å¤æˆåŠŸï¼', 'success');
                    log(resultId, '\nåŸå§‹å›å¤:');
                    log(resultId, content);

                    try {
                        const cleaned = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                        const parsed = JSON.parse(cleaned);
                        log(resultId, '\nâœ… JSON è§£ææˆåŠŸï¼', 'success');
                        log(resultId, `æŒ‡ä»¤æ•°é‡: ${parsed.commands?.length || 0}`);
                    } catch (e) {
                        log(resultId, '\nâš ï¸  JSON è§£æå¤±è´¥', 'error');
                    }
                } else {
                    log(resultId, `âŒ API é”™è¯¯: ${response.status}`, 'error');
                }
            } catch (error) {
                log(resultId, `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testJSONParsing() {
            const resultId = 'test4-result';
            clear(resultId);
            log(resultId, 'æµ‹è¯• JSON è§£æé€»è¾‘...', 'loading');

            const testCases = [
                {
                    name: 'æ ‡å‡† JSON',
                    input: '{"commands": [{"action": "test"}], "message": "hello"}'
                },
                {
                    name: 'å¸¦ markdown ä»£ç å—',
                    input: '```json\n{"commands": [], "message": "test"}\n```'
                },
                {
                    name: 'çº¯æ–‡æœ¬ï¼ˆåº”è¯¥å¤±è´¥ï¼‰',
                    input: 'This is not JSON'
                }
            ];

            testCases.forEach(testCase => {
                log(resultId, `\næµ‹è¯•: ${testCase.name}`);
                try {
                    const cleaned = testCase.input.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                    const parsed = JSON.parse(cleaned);
                    log(resultId, `âœ… è§£ææˆåŠŸ: ${JSON.stringify(parsed)}`, 'success');
                } catch (error) {
                    log(resultId, `âŒ è§£æå¤±è´¥: ${error.message}`, 'error');
                }
            });
        }

        // è‡ªåŠ¨è¿è¡Œç¬¬ä¸€ä¸ªæµ‹è¯•
        window.onload = () => {
            setTimeout(() => {
                log('test1-result', 'é¡µé¢åŠ è½½å®Œæˆï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•ï¼', 'success');
            }, 500);
        };
    </script>
</body>
</html>
